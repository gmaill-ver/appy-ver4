<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â≠¶Áøí„Éà„É©„ÉÉ„Ç´„Éº - Ë°åÊîøÊõ∏Â£´Ë©¶È®ìÂØæÁ≠ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --secondary: #3498db;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --gray-light: #9ca3af;
            --gray-lighter: #d1d5db;
            --light: #f3f4f6;
            --lighter: #f9fafb;
            --white: #ffffff;
            --weekend-bg: #e8e8e8;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans CJK JP', sans-serif;
            background: var(--lighter);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .app-logo-icon {
            font-size: 24px;
        }
        
        .app-title {
            font-size: 22px;
            font-weight: 700;
        }
        
        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* „Çø„Ç§„Éû„Éº„Ç¢„Ç§„Ç≥„É≥Ôºà„Åï„Çâ„Å´Â∞è„Åï„ÅèÔºâ */
        .timer-icon-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .timer-icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* „Çø„Ç§„Éû„ÉºË°®Á§∫Ôºà„Éò„ÉÉ„ÉÄ„ÉºÂè≥‰∏ãÔºâ */
        .timer-display {
            position: absolute;
            bottom: 10px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }
        
        .timer-display.active {
            display: block;
        }
        
        /* Ë©¶È®ìÊó•„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */
        .exam-countdown {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 5px;
        }
        
        .exam-countdown .days {
            font-weight: 700;
            color: #ffd700;
            font-size: 16px;
        }
        
        /* „Çø„Ç§„Éû„Éº„É¢„Éº„ÉÄ„É´ */
        .timer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .timer-modal.active {
            display: flex;
        }
        
        .timer-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .timer-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .timer-tab {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .timer-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .timer-display-large {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: var(--primary);
        }
        
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .timer-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .timer-btn.start {
            background: var(--success);
            color: white;
        }
        
        .timer-btn.pause {
            background: var(--warning);
            color: white;
        }
        
        .timer-btn.reset {
            background: var(--gray);
            color: white;
        }
        
        .timer-input-group {
            margin: 15px 0;
        }
        
        .timer-input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .timer-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .timer-input {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--light);
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
        }
        
        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px;
            box-shadow: var(--shadow);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-nav-btn {
            background: var(--light);
            border: none;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .calendar-nav-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .calendar-month {
            font-weight: 700;
            font-size: 16px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            padding: 5px;
        }
        
        .calendar-weekday.weekend {
            color: var(--danger);
        }
        
        .calendar-day {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--light);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 14px;
            padding: 3px;
        }
        
        .calendar-day:hover {
            background: var(--light);
        }
        
        .calendar-day.weekend {
            background: var(--weekend-bg);
        }
        
        .calendar-day.other-month {
            color: var(--gray-light);
        }
        
        .calendar-day.today {
            background: var(--primary);
            color: white;
        }
        
        .calendar-day.selected {
            background: var(--secondary);
            color: white;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .calendar-day-plans {
            font-size: 9px;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            color: inherit;
        }
        
        .calendar-plan-text {
            margin: 1px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendar-plan-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .calendar-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-btn.add-plan {
            background: var(--primary);
            color: white;
        }
        
        .calendar-btn.view-plans {
            background: var(--light);
            color: var(--dark);
        }
        
        /* Â≠¶ÁøíË®àÁîª„É¢„Éº„ÉÄ„É´ */
        .plan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2500;
            align-items: center;
            justify-content: center;
        }
        
        .plan-modal.active {
            display: flex;
        }
        
        .plan-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .plan-form-group {
            margin-bottom: 15px;
        }
        
        .plan-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .plan-form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .plan-display-type {
            display: flex;
            gap: 15px;
            margin: 10px 0;
        }
        
        .plan-display-type label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .date-range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range-inputs input {
            flex: 1;
        }
        
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: var(--dark);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        
        .plan-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .plan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--light);
        }
        
        .plan-item-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .plan-item-content {
            flex: 1;
        }
        
        .plan-item-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .plan-item-date {
            font-size: 12px;
            color: var(--gray);
        }
        
        .plan-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .plan-item-edit, .plan-item-delete {
            padding: 5px 10px;
            background: transparent;
            color: var(--gray);
            border: 1px solid var(--gray-light);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .plan-item-edit:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .plan-item-delete:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* „É°„Ç§„É≥„Çø„ÉñÔºà3„Å§Ôºâ */
        .main-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .main-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: white;
            color: var(--gray);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .main-tab.active {
            color: var(--primary);
        }
        
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }
        
        /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .content-area {
            flex: 1;
            padding-bottom: 80px;
            overflow-y: auto;
        }
        
        /* „Ç´„Éº„Éâ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light);
        }
        
        .card-icon {
            font-size: 20px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* „Ç´„Éº„Éâ‰∏¶„Å≥Êõø„Åà„Éú„Çø„É≥ */
        .card-sort-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 5px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }
        
        /* „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å™„Ç´„Éº„Éâ */
        .sortable-card {
            cursor: move;
        }
        
        .sortable-card.dragging {
            opacity: 0.5;
        }
        
        /* ÂïèÈ°åÈõÜ„Ç´„Éº„ÉâÈÅ∏ÊäûÔºàÈñãÈñâÂºèÔºâ */
        .book-cards-wrapper {
            position: relative;
        }
        
        .book-order-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            padding: 5px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }
        
        .book-card {
            background: white;
            border: 2px solid var(--light);
            border-radius: 12px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .book-card.dragging {
            opacity: 0.5;
        }
        
        .book-card-drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            display: none;
            color: var(--gray);
        }
        
        .book-card.sortable .book-card-drag-handle {
            display: block;
        }
        
        .book-card:hover {
            border-color: var(--secondary);
            box-shadow: var(--shadow-lg);
        }
        
        .book-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.05), rgba(52, 152, 219, 0.05));
        }
        
        .book-card-title {
            font-weight: 600;
            margin-bottom: 5px;
            margin-left: 20px;
        }
        
        .book-card-meta {
            font-size: 12px;
            color: var(--gray);
            margin-left: 20px;
        }
        
        /* ÈöéÂ±§„É™„Çπ„ÉàË°®Á§∫ÔºàÁµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ */
        .hierarchy-list {
            padding: 10px;
        }
        
        .hierarchy-item {
            border: 1px solid var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .hierarchy-row {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .hierarchy-row:hover {
            background: var(--lighter);
        }
        
        .hierarchy-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 10px;
            transition: transform 0.3s;
            color: var(--gray-lighter);
        }
        
        .hierarchy-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .hierarchy-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .hierarchy-label {
            flex: 1;
            font-weight: 500;
        }
        
        .hierarchy-meta {
            margin-left: auto;
            margin-right: 10px;
            font-size: 12px;
            color: var(--gray);
        }
        
        .hierarchy-actions {
            display: flex;
            gap: 5px;
        }
        
        .hierarchy-action {
            padding: 4px;
            background: transparent;
            color: var(--gray-light);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 28px;
            height: 28px;
        }
        
        .hierarchy-action:hover {
            color: var(--gray);
            background: rgba(107, 114, 128, 0.1);
        }
        
        .hierarchy-action.edit {
            color: var(--gray-light);
        }
        
        .hierarchy-action.edit:hover {
            color: var(--primary);
            background: rgba(44, 62, 80, 0.1);
        }
        
        .hierarchy-action.delete {
            color: var(--danger);
        }
        
        .hierarchy-action.delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .hierarchy-children {
            display: none;
            background: var(--lighter);
            padding: 8px;
        }
        
        .hierarchy-children.expanded {
            display: block;
        }
        
        /* „Éë„É≥„Åè„Åö„É™„Çπ„Éà */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            margin: 10px;
            flex-wrap: wrap;
            font-size: 13px;
        }
        
        .breadcrumb-item {
            color: var(--gray);
            cursor: pointer;
            white-space: nowrap;
        }
        
        .breadcrumb-item:hover {
            color: var(--primary);
        }
        
        .breadcrumb-item.active {
            color: var(--primary);
            font-weight: 600;
        }
        
        .breadcrumb-separator {
            color: var(--gray);
            font-size: 10px;
        }
        
        /* „Éí„Éº„Éà„Éû„ÉÉ„Éó */
        .heatmap-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .heatmap-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .heatmap-select {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .heatmap-toggle-btn {
            padding: 8px 15px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .heatmap-toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(25px, 1fr));
            gap: 1px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .heatmap-label {
            grid-column: 1 / -1;
            font-size: 9px;
            color: var(--gray);
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--light);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .heatmap-cell.correct {
            background: var(--success);
            color: white;
        }
        
        .heatmap-cell.wrong {
            background: var(--danger);
            color: white;
        }
        
        .heatmap-cell.bookmarked::after {
            content: '‚òÖ';
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 8px;
            color: var(--warning);
        }
        
        /* „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà */
        .radar-chart-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .radar-chart-controls {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }
        
        .radar-chart-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .radar-toggle-btn {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .radar-toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .radar-chart {
            width: 300px;
            height: 300px;
            position: relative;
        }
        
        /* Â≠¶Áøí„Ç∞„É©„ÉïÔºàÁ∏¶Ê£íÔºâ */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chart-btn {
            padding: 8px 15px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .chart-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .chart-wrapper {
            height: 200px;
            position: relative;
            padding: 10px 0;
        }
        
        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
        }
        
        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            position: relative;
        }
        
        .chart-bar-value {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .chart-bar-container {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .chart-bar {
            width: 60%;
            max-width: 30px;
            background: linear-gradient(to top, var(--primary), var(--secondary));
            border-radius: 3px 3px 0 0;
            transition: all 0.3s;
        }
        
        .chart-bar.today {
            background: linear-gradient(to top, var(--warning), var(--secondary));
        }
        
        .chart-bar-label {
            font-size: 11px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        /* ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏Ôºà4ÂàóÔºâ */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .achievement-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .achievement-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .achievement-icon.disabled {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        
        .achievement-label {
            font-size: 10px;
            color: var(--gray);
            text-align: center;
            margin-bottom: 2px;
        }
        
        .achievement-value {
            font-size: 12px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Áµ±Ë®à„Ç∞„É™„ÉÉ„Éâ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            padding: 15px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* ÈÄ≤Êçó„Éê„Éº */
        .progress-bar-container {
            height: 12px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .action-btn.correct {
            background: var(--success);
        }
        
        .action-btn.wrong {
            background: var(--danger);
        }
        
        .action-btn.bookmark {
            background: var(--warning);
        }
        
        .action-btn.bookmark.active {
            background: linear-gradient(135deg, var(--warning), var(--secondary));
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        /* ÂïèÈ°å„Ç∞„É™„ÉÉ„Éâ */
        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            gap: 5px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .question-cell {
            aspect-ratio: 1;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .question-cell.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .question-cell.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .question-cell.bookmarked::after {
            content: '‚òÖ';
            position: absolute;
            top: -3px;
            right: -3px;
            font-size: 10px;
            color: var(--warning);
        }
        
        /* ‰∏ÄÂïè‰∏ÄÁ≠î„Ç´„Éº„Éâ */
        .qa-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            box-shadow: var(--shadow);
            min-height: 200px;
        }
        
        .qa-question {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .qa-answer {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .qa-answer.show {
            display: block;
        }
        
        .qa-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .qa-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .qa-btn.show-answer {
            background: var(--primary);
            color: white;
        }
        
        .qa-btn.correct {
            background: var(--success);
            color: white;
        }
        
        .qa-btn.wrong {
            background: var(--danger);
            color: white;
        }
        
        .qa-btn.next {
            background: var(--secondary);
            color: white;
        }
        
        .qa-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .qa-selector select {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .qa-selector button {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .qa-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .qa-progress-text {
            font-size: 14px;
            font-weight: 600;
        }
        
        .qa-stats {
            display: flex;
            gap: 15px;
        }
        
        .qa-stat {
            font-size: 12px;
        }
        
        .qa-stat-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ */
        .accordion {
            margin-bottom: 10px;
        }
        
        .accordion-header {
            background: white;
            border: 1px solid var(--light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .accordion-header:hover {
            background: var(--light);
        }
        
        .accordion-header.active {
            border-radius: 10px 10px 0 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .accordion-content {
            display: none;
            background: white;
            border: 1px solid var(--light);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 15px;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        .accordion-arrow {
            transition: transform 0.3s;
            font-size: 10px;
            color: var(--gray-lighter);
        }
        
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
            color: white;
        }
        
        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* CSV„Ç§„É≥„Éù„Éº„Éà */
        .import-section {
            margin: 20px 0;
            padding: 15px;
            background: var(--lighter);
            border-radius: 10px;
        }
        
        .import-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .import-help {
            margin-top: 10px;
            padding: 10px;
            background: var(--white);
            border-left: 3px solid var(--primary);
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        /* ÂâäÈô§„É™„Çπ„Éà */
        .delete-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--light);
        }
        
        .delete-list-item:hover {
            background: var(--lighter);
        }
        
        .delete-btn {
            padding: 5px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        /* ‰øùÂ≠ò„Éú„Çø„É≥ */
        .save-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        }
        
        /* CSV„É™„Çπ„Éà */
        .csv-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .csv-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }
        
        .csv-item-info {
            flex: 1;
        }
        
        .csv-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .csv-item-meta {
            font-size: 12px;
            color: var(--gray);
        }
        
        .csv-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .csv-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .csv-btn.edit {
            background: var(--primary);
            color: white;
        }
        
        .csv-btn.apply {
            background: var(--success);
            color: white;
        }
        
        .csv-btn.delete {
            background: var(--danger);
            color: white;
        }
        
        /* Áï™Âè∑„Çø„Ç§„Éó„Çª„É¨„ÇØ„Çø */
        .numbering-type {
            display: flex;
            gap: 15px;
            margin: 10px 0;
        }
        
        .numbering-type label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        /* „Éï„ÉÉ„Çø„Éº„Çø„Éñ */
        .footer-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            padding: 5px 0;
            z-index: 100;
        }
        
        .footer-tab {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            border: none;
            background: none;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .footer-tab.active {
            color: var(--primary);
        }
        
        .footer-tab-icon {
            font-size: 20px;
        }
        
        .footer-tab-label {
            font-size: 11px;
        }
        
        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* „É¢„Éº„ÉÄ„É´ÔºàÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑÔºâ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
        }
        
        .modal-content {
            background: white;
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            padding: 20px 10px 100px 10px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .modal-close {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* „É¢„Éº„ÉÄ„É´‰∏ãÈÉ®Èñâ„Åò„Çã„Éú„Çø„É≥ */
        .modal-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 2001;
        }
        
        .modal-close-bottom {
            width: 100%;
            padding: 15px;
            background: var(--gray);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-close-bottom:hover {
            background: var(--dark);
        }
        
        /* ÂÖ•Âäõ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .input-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            width: 90%;
            max-width: 400px;
        }
        
        .input-dialog h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .dialog-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dialog-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .dialog-btn.secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2999;
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .achievement-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="openTimerModal()" title="„Çø„Ç§„Éû„Éº">
            ‚è∞
        </button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">üìö</span>
            <span class="app-title">Â≠¶Áøí„Éà„É©„ÉÉ„Ç´„Éº</span>
        </div>
        <div class="exam-countdown" id="examCountdown">
            Ë©¶È®ìÊó•„Åæ„Åß <span class="days">--</span> Êó•
        </div>
    </header>
    
    <!-- „É°„Ç§„É≥„Çø„ÉñÔºà3„Å§Ôºâ -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('record', event)">Ë®òÈå≤ÂÖ•Âäõ</button>
        <button class="main-tab" onclick="switchMainTab('analysis', event)">ÂàÜÊûê</button>
        <button class="main-tab" onclick="switchMainTab('progress', event)">ÈÄ≤Êçó</button>
    </div>
    
    <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
    <div class="content-area">
        <!-- Ë®òÈå≤ÂÖ•Âäõ„Çø„Éñ -->
        <div id="record-tab" class="tab-content active">
            <!-- ÂïèÈ°åÈõÜÈÅ∏ÊäûÔºàÈñãÈñâÂºè„Ç´„Éº„ÉâÔºâ -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="toggleBookSort()">‰∏¶Êõø„Åà</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- „Éë„É≥„Åè„Åö„É™„Çπ„Éà -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- ÈöéÂ±§„É™„Çπ„ÉàÔºàË®òÈå≤Áî®Ôºâ -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- ÂïèÈ°åÂÖ•Âäõ -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">‚úçÔ∏è</span>
                    <span class="card-title">ÂïèÈ°åÂà•Ê≠£Ë™§ÂÖ•Âäõ</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn correct" onclick="markCorrect()">
                        <span>‚≠ï</span>
                        <span>Ê≠£Ëß£</span>
                    </button>
                    <button class="action-btn wrong" onclick="markWrong()">
                        <span>‚ùå</span>
                        <span>‰∏çÊ≠£Ëß£</span>
                    </button>
                    <button class="action-btn bookmark" id="bookmarkBtn" onclick="toggleBookmarkMode()">
                        <span>‚≠ê</span>
                        <span>„Éû„Éº„ÇØ</span>
                    </button>
                </div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Ëß£Á≠îÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">Ê≠£Ëß£Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">‰∏çÊ≠£Ëß£Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">Ê≠£Á≠îÁéá</div>
                    </div>
                </div>
                
                <button class="save-button" onclick="saveRecord()">Â≠¶ÁøíË®òÈå≤„Çí‰øùÂ≠ò</button>
            </div>
            
            <!-- „Ç´„É¨„É≥„ÉÄ„ÉºÔºàÊúÄ‰∏ãÈÉ®Ôºâ -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
                        <span class="calendar-month" id="calendarMonth">2025Âπ¥1Êúà</span>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="goToToday()">‰ªäÊó•</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="openPlanModal()">üìù Â≠¶ÁøíË®àÁîª„ÇíËøΩÂä†</button>
                    <button class="calendar-btn view-plans" onclick="viewPlans()">üìã Ë®àÁîª‰∏ÄË¶ß</button>
                </div>
            </div>
        </div>
        
        <!-- ÂàÜÊûê„Çø„Éñ -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="toggleAnalysisSort()">‰∏¶Êõø„Åà</button>
            <div id="analysisCardsContainer">
                <!-- Â≠¶Áøí„Ç∞„É©„Éï -->
                <div class="accordion card" data-card-id="chart">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>üìä Â≠¶Áøí„Ç∞„É©„Éï</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="switchChartView('day', this)">Êó•Âà•</button>
                            <button class="chart-btn" onclick="switchChartView('week', this)">ÈÄ±Èñì</button>
                            <button class="chart-btn" onclick="switchChartView('month', this)">ÊúàÈñì</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Â≠¶ÁøíÂ±•Ê≠¥ -->
                <div class="accordion card" data-card-id="history">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>üìÖ Â≠¶ÁøíÂ±•Ê≠¥</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
                
                <!-- „Éí„Éº„Éà„Éû„ÉÉ„Éó -->
                <div class="accordion card" data-card-id="heatmap">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>üó∫Ô∏è ÂïèÈ°å„Éí„Éº„Éà„Éû„ÉÉ„Éó</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="heatmap-controls">
                            <select class="heatmap-select" id="heatmapBookSelect" onchange="updateHeatmap()">
                                <option value="">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû</option>
                            </select>
                            <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="toggleHeatmapPinned()">üìå Âõ∫ÂÆö</button>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- Âº±ÁÇπÂàÜÊûê -->
                <div class="accordion" data-card-id="weakness">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>üéØ Âº±ÁÇπÂàÜÊûê</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÈÄ≤Êçó„Çø„Éñ -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üìä</span>
                    <span class="card-title">ÂÖ®‰ΩìÈÄ≤ÊçóÁä∂Ê≥Å</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üìà</span>
                    <span class="card-title">ÁßëÁõÆÂà•ÈÄ≤Êçó</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <select class="radar-chart-select" id="radarBookSelect" onchange="drawRadarChart()">
                            <option value="">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû</option>
                        </select>
                        <button class="radar-toggle-btn" id="radarToggleBtn" onclick="toggleRadarPinned()">üìå Âõ∫ÂÆöË°®Á§∫</button>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="setRadarMode('subject', this)">ÁßëÁõÆÂà•</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="setRadarMode('compare', this)">ÂïèÈ°åÈõÜÊØîËºÉ</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Éï„ÉÉ„Çø„Éº„Çø„Éñ -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="switchFooterTab('register', event)">
            <span class="footer-tab-icon">üìù</span>
            <span class="footer-tab-label">ÁôªÈå≤</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('qa', event)">
            <span class="footer-tab-icon">‚ùì</span>
            <span class="footer-tab-label">‰∏ÄÂïè‰∏ÄÁ≠î</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('results', event)">
            <span class="footer-tab-icon">üèÜ</span>
            <span class="footer-tab-label">ÂÆüÁ∏æ</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('settings', event)">
            <span class="footer-tab-icon">‚öôÔ∏è</span>
            <span class="footer-tab-label">Ë®≠ÂÆö</span>
        </button>
    </div>
    
    <!-- „Çø„Ç§„Éû„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>‚è∞ „Çø„Ç§„Éû„Éº</h3>
                <button class="modal-close" onclick="closeTimerModal()">√ó</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="switchTimerTab('stopwatch', this)">„Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅ</button>
                <button class="timer-tab" onclick="switchTimerTab('countdown', this)">„Çø„Ç§„Éû„Éº</button>
                <button class="timer-tab" onclick="switchTimerTab('interval', this)">„Ç§„É≥„Çø„Éº„Éê„É´</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="startStopwatch()">ÈñãÂßã</button>
                    <button class="timer-btn pause" onclick="pauseStopwatch()">‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="timer-btn reset" onclick="resetStopwatch()">„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">„Çø„Ç§„Éû„ÉºË®≠ÂÆö</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="ÊôÇ" min="0" max="23">
                        <span>ÊôÇÈñì</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="ÂàÜ" min="0" max="59">
                        <span>ÂàÜ</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="Áßí" min="0" max="59">
                        <span>Áßí</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="startCountdown()">ÈñãÂßã</button>
                    <button class="timer-btn pause" onclick="pauseCountdown()">‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="timer-btn reset" onclick="resetCountdown()">„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">‰ΩúÊ•≠ÊôÇÈñì</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>ÂàÜ</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">‰ºëÊÜ©ÊôÇÈñì</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>ÂàÜ</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">„Çª„ÉÉ„ÉàÊï∞</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>„Çª„ÉÉ„Éà</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">ÂæÖÊ©ü‰∏≠</span> | 
                    <span id="intervalSetCount">0/0 „Çª„ÉÉ„Éà</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="startInterval()">ÈñãÂßã</button>
                    <button class="timer-btn pause" onclick="pauseInterval()">‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="timer-btn reset" onclick="resetInterval()">„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Â≠¶ÁøíË®àÁîª„É¢„Éº„ÉÄ„É´ -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">üìÖ Â≠¶ÁøíË®àÁîª</h3>
                <button class="modal-close" onclick="closePlanModal()">√ó</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">Ë®àÁîª„Çø„Ç§„Éà„É´</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="‰æãÔºöÊ∞ëÊ≥ïÁ∑èÂâá„ÅÆÂæ©Áøí">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">Ë®àÁîªÂÜÖÂÆπ</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="Â≠¶ÁøíÂÜÖÂÆπ„ÅÆË©≥Á¥∞„ÇíÂÖ•Âäõ"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">Ë°®Á§∫ÂΩ¢Âºè</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>„Éª</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>ÈÄöÂ∏∏Ë°®Á§∫</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">Êó•‰ªòÁØÑÂõ≤</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>„Äú</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">Ëâ≤Ë®≠ÂÆö</label>
                    <div class="color-picker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="savePlan()">Ë®àÁîª„Çí‰øùÂ≠ò</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>ÁôªÈå≤Ê∏à„Åø„ÅÆË®àÁîª</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- „Éï„ÉÉ„Çø„Éº„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">„Çø„Ç§„Éà„É´</h3>
                <button class="modal-close" onclick="closeFooterModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="closeFooterModal()">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- ÂÖ•Âäõ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">„Çø„Ç§„Éà„É´</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="closeDialog()">„Ç≠„É£„É≥„Çª„É´</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">Á¢∫ÂÆö</button>
        </div>
    </div>
    
    <script>
        // „Éá„Éº„ÇøÊßãÈÄ†
        let books = {};
        let bookOrder = [];
        let currentBook = null;
        let currentPath = [];
        let questionStates = {};
        let allRecords = [];
        let bookmarkMode = false;
        let currentChartView = 'day';
        let expandedNodes = new Set();
        let savedQuestionStates = {};
        let selectedBookCard = null;
        let radarChartMode = 'subject';
        let sortMode = false;
        let analysisSortMode = false;
        let analysisCardOrder = ['chart', 'history', 'heatmap', 'weakness'];
        let heatmapPinnedBook = null;
        let radarPinnedBook = null;
        let qaQuestions = {};
        let currentQASet = [];
        let currentQAIndex = 0;
        let qaAnswerShown = false;
        let qaStats = { total: 0, correct: 0, wrong: 0 };
        let csvTemplates = {};
        
        // „Çø„Ç§„Éû„ÉºÈñ¢ÈÄ£
        let timerInterval = null;
        let stopwatchTime = 0;
        let countdownTime = 0;
        let intervalTime = 0;
        let currentIntervalSet = 0;
        let isWorkTime = true;
        let timerMode = 'stopwatch';
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºÈñ¢ÈÄ£
        let currentDate = new Date();
        let selectedDate = null;
        let studyPlans = [];
        let selectedPlanColor = '#3498db';
        
        // Ë©¶È®ìÊó•
        let examDate = null;
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadBooksFromStorage();
            loadBookOrder();
            loadAnalysisCardOrder();
            loadCSVTemplates();
            initializeSampleData();
            renderBookCards();
            loadAllRecords();
            loadSavedQuestionStates();
            loadQAQuestions();
            updateChartBars();
            updateHeatmapBookSelect();
            updateRadarBookSelect();
            loadStudyPlans();
            renderCalendar();
            loadExamDate();
            updateExamCountdown();
            loadPinnedSettings();
            updateHistoryContent();
            
            // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPlanColor = this.dataset.color;
                });
            });
        });
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ
        function loadCSVTemplates() {
            const saved = localStorage.getItem('csvTemplates');
            if (saved) {
                csvTemplates = JSON.parse(saved);
            }
        }
        
        function saveCSVTemplates() {
            localStorage.setItem('csvTemplates', JSON.stringify(csvTemplates));
        }
        
        // ÂàÜÊûê„Ç´„Éº„ÉâÈ†ÜÂ∫èÁÆ°ÁêÜ
        function loadAnalysisCardOrder() {
            const saved = localStorage.getItem('analysisCardOrder');
            if (saved) {
                analysisCardOrder = JSON.parse(saved);
            }
        }
        
        function saveAnalysisCardOrder() {
            localStorage.setItem('analysisCardOrder', JSON.stringify(analysisCardOrder));
        }
        
        // ÂàÜÊûê„Çø„Éñ‰∏¶„Å≥Êõø„Åà
        function toggleAnalysisSort() {
            analysisSortMode = !analysisSortMode;
            const container = document.getElementById('analysisCardsContainer');
            
            if (analysisSortMode) {
                container.classList.add('sortable-container');
                enableAnalysisDragAndDrop();
            } else {
                container.classList.remove('sortable-container');
            }
        }
        
        // ÂàÜÊûê„Ç´„Éº„Éâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó
        function enableAnalysisDragAndDrop() {
            const container = document.getElementById('analysisCardsContainer');
            let draggedElement = null;
            
            const cards = container.querySelectorAll('.card');
            cards.forEach(card => {
                card.draggable = true;
                card.classList.add('sortable-card');
                
                card.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                card.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                card.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    
                    const draggingCard = container.querySelector('.dragging');
                    const afterElement = getDragAfterElement(container, e.clientY);
                    
                    if (afterElement == null) {
                        container.appendChild(draggingCard);
                    } else {
                        container.insertBefore(draggingCard, afterElement);
                    }
                });
                
                card.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    // Êñ∞„Åó„ÅÑÈ†ÜÂ∫è„Çí‰øùÂ≠ò
                    const newOrder = [];
                    container.querySelectorAll('.card').forEach(c => {
                        const cardId = c.dataset.cardId;
                        if (cardId) newOrder.push(cardId);
                    });
                    analysisCardOrder = newOrder;
                    saveAnalysisCardOrder();
                    
                    return false;
                });
            });
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÂïèÈ°å„ÅÆË™≠„ÅøËæº„Åø
        function loadQAQuestions() {
            const saved = localStorage.getItem('qaQuestions');
            if (saved) {
                qaQuestions = JSON.parse(saved);
            }
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÂïèÈ°å„ÅÆ‰øùÂ≠ò
        function saveQAQuestions() {
            localStorage.setItem('qaQuestions', JSON.stringify(qaQuestions));
        }
        
        // ÂïèÈ°åÈõÜÈ†ÜÂ∫è„ÅÆË™≠„ÅøËæº„Åø
        function loadBookOrder() {
            const saved = localStorage.getItem('bookOrder');
            if (saved) {
                bookOrder = JSON.parse(saved);
            } else {
                bookOrder = Object.keys(books);
            }
        }
        
        // ÂïèÈ°åÈõÜÈ†ÜÂ∫è„ÅÆ‰øùÂ≠ò
        function saveBookOrder() {
            localStorage.setItem('bookOrder', JSON.stringify(bookOrder));
        }
        
        // „Éî„É≥Âõ∫ÂÆöË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        function loadPinnedSettings() {
            const heatmapPinned = localStorage.getItem('heatmapPinnedBook');
            if (heatmapPinned) {
                heatmapPinnedBook = heatmapPinned;
                const select = document.getElementById('heatmapBookSelect');
                if (select) {
                    select.value = heatmapPinnedBook;
                    document.getElementById('heatmapToggleBtn').classList.add('active');
                    updateHeatmap();
                }
            }
            
            const radarPinned = localStorage.getItem('radarPinnedBook');
            if (radarPinned) {
                radarPinnedBook = radarPinned;
                const select = document.getElementById('radarBookSelect');
                if (select) {
                    select.value = radarPinnedBook;
                    document.getElementById('radarToggleBtn').classList.add('active');
                    drawRadarChart();
                }
            }
        }
        
        // „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆ„Éî„É≥Âõ∫ÂÆöÂàá„ÇäÊõø„Åà
        function toggleHeatmapPinned() {
            const select = document.getElementById('heatmapBookSelect');
            const btn = document.getElementById('heatmapToggleBtn');
            
            if (heatmapPinnedBook) {
                heatmapPinnedBook = null;
                localStorage.removeItem('heatmapPinnedBook');
                btn.classList.remove('active');
            } else {
                if (select.value) {
                    heatmapPinnedBook = select.value;
                    localStorage.setItem('heatmapPinnedBook', heatmapPinnedBook);
                    btn.classList.add('active');
                } else {
                    alert('Âõ∫ÂÆö„Åô„ÇãÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }
        }
        
        // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà„ÅÆ„Éî„É≥Âõ∫ÂÆöÂàá„ÇäÊõø„Åà
        function toggleRadarPinned() {
            const select = document.getElementById('radarBookSelect');
            const btn = document.getElementById('radarToggleBtn');
            
            if (radarPinnedBook) {
                radarPinnedBook = null;
                localStorage.removeItem('radarPinnedBook');
                btn.classList.remove('active');
            } else {
                if (select.value) {
                    radarPinnedBook = select.value;
                    localStorage.setItem('radarPinnedBook', radarPinnedBook);
                    btn.classList.add('active');
                } else {
                    alert('Âõ∫ÂÆö„Åô„ÇãÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }
        }
        
        // ÂïèÈ°åÈõÜ„Ç´„Éº„Éâ„ÅÆ„ÇΩ„Éº„Éà„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleBookSort() {
            sortMode = !sortMode;
            renderBookCards();
            
            if (sortMode) {
                enableDragAndDrop();
            }
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅÆÊúâÂäπÂåñ
        function enableDragAndDrop() {
            const container = document.getElementById('bookCardsContainer');
            let draggedElement = null;
            
            const cards = container.querySelectorAll('.book-card');
            cards.forEach(card => {
                card.draggable = true;
                
                card.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                });
                
                card.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                card.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    
                    const draggingCard = container.querySelector('.dragging');
                    const afterElement = getDragAfterElement(container, e.clientY);
                    
                    if (afterElement == null) {
                        container.appendChild(draggingCard);
                    } else {
                        container.insertBefore(draggingCard, afterElement);
                    }
                });
                
                card.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    // Êñ∞„Åó„ÅÑÈ†ÜÂ∫è„Çí‰øùÂ≠ò
                    const newOrder = [];
                    container.querySelectorAll('.book-card').forEach(c => {
                        const bookId = c.id.replace('book-card-', '');
                        newOrder.push(bookId);
                    });
                    bookOrder = newOrder;
                    saveBookOrder();
                    
                    return false;
                });
            });
        }
        
        // „Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÅÆË®àÁÆó
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.book-card:not(.dragging),.card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Ë©¶È®ìÊó•Ë®≠ÂÆöË™≠„ÅøËæº„Åø
        function loadExamDate() {
            const saved = localStorage.getItem('examDate');
            if (saved) {
                examDate = new Date(saved);
            }
        }
        
        // Ë©¶È®ìÊó•„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Êõ¥Êñ∞
        function updateExamCountdown() {
            const countdown = document.getElementById('examCountdown');
            if (examDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const exam = new Date(examDate);
                exam.setHours(0, 0, 0, 0);
                const diffTime = exam - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    countdown.innerHTML = `Ë©¶È®ìÊó•„Åæ„Åß <span class="days">${diffDays}</span> Êó•`;
                } else if (diffDays === 0) {
                    countdown.innerHTML = `<span class="days">Ë©¶È®ìÂΩìÊó•ÔºÅ</span>`;
                } else {
                    countdown.innerHTML = `Ë©¶È®ìÁµÇ‰∫Ü`;
                }
            } else {
                countdown.innerHTML = `Ë©¶È®ìÊó•„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
            }
        }
        
        // „Çø„Ç§„Éû„Éº„É¢„Éº„ÉÄ„É´ÈñãÈñâ
        function openTimerModal() {
            document.getElementById('timerModal').classList.add('active');
        }
        
        function closeTimerModal() {
            document.getElementById('timerModal').classList.remove('active');
        }
        
        // „Çø„Ç§„Éû„Éº„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTimerTab(tab, btn) {
            document.querySelectorAll('.timer-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.timer-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(tab + 'Tab').style.display = 'block';
            timerMode = tab;
        }
        
        // „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅÊ©üËÉΩ
        function startStopwatch() {
            if (timerInterval) return;
            
            timerInterval = setInterval(() => {
                stopwatchTime++;
                updateStopwatchDisplay();
                updateHeaderTimerDisplay();
            }, 1000);
            
            document.getElementById('timerDisplay').classList.add('active');
        }
        
        function pauseStopwatch() {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        function resetStopwatch() {
            clearInterval(timerInterval);
            timerInterval = null;
            stopwatchTime = 0;
            updateStopwatchDisplay();
            document.getElementById('timerDisplay').classList.remove('active');
        }
        
        function updateStopwatchDisplay() {
            const hours = Math.floor(stopwatchTime / 3600);
            const minutes = Math.floor((stopwatchTime % 3600) / 60);
            const seconds = stopwatchTime % 60;
            const display = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            document.getElementById('stopwatchDisplay').textContent = display;
            if (timerMode === 'stopwatch') {
                document.getElementById('timerDisplay').textContent = display;
            }
        }
        
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ê©üËÉΩ
        function startCountdown() {
            if (timerInterval) return;
            
            const hours = parseInt(document.getElementById('countdownHours').value) || 0;
            const minutes = parseInt(document.getElementById('countdownMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('countdownSeconds').value) || 0;
            
            if (countdownTime === 0) {
                countdownTime = hours * 3600 + minutes * 60 + seconds;
            }
            
            if (countdownTime === 0) {
                alert('ÊôÇÈñì„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            timerInterval = setInterval(() => {
                countdownTime--;
                updateCountdownDisplay();
                updateHeaderTimerDisplay();
                
                if (countdownTime <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    alert('„Çø„Ç§„Éû„ÉºÁµÇ‰∫ÜÔºÅ');
                    resetCountdown();
                }
            }, 1000);
            
            document.getElementById('timerDisplay').classList.add('active');
        }
        
        function pauseCountdown() {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        function resetCountdown() {
            clearInterval(timerInterval);
            timerInterval = null;
            countdownTime = 0;
            updateCountdownDisplay();
            document.getElementById('timerDisplay').classList.remove('active');
        }
        
        function updateCountdownDisplay() {
            const hours = Math.floor(countdownTime / 3600);
            const minutes = Math.floor((countdownTime % 3600) / 60);
            const seconds = countdownTime % 60;
            const display = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            document.getElementById('countdownDisplay').textContent = display;
            if (timerMode === 'countdown') {
                document.getElementById('timerDisplay').textContent = display;
            }
        }
        
        // „Ç§„É≥„Çø„Éº„Éê„É´Ê©üËÉΩ
        function startInterval() {
            if (timerInterval) return;
            
            const workMinutes = parseInt(document.getElementById('workMinutes').value) || 25;
            const breakMinutes = parseInt(document.getElementById('breakMinutes').value) || 5;
            const totalSets = parseInt(document.getElementById('intervalSets').value) || 4;
            
            if (intervalTime === 0) {
                currentIntervalSet = 1;
                isWorkTime = true;
                intervalTime = workMinutes * 60;
            }
            
            updateIntervalStatus(totalSets);
            
            timerInterval = setInterval(() => {
                intervalTime--;
                updateIntervalDisplay();
                updateHeaderTimerDisplay();
                
                if (intervalTime <= 0) {
                    if (isWorkTime) {
                        isWorkTime = false;
                        intervalTime = breakMinutes * 60;
                        alert('‰ºëÊÜ©ÊôÇÈñì„Åß„ÅôÔºÅ');
                    } else {
                        if (currentIntervalSet >= totalSets) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            alert('„Ç§„É≥„Çø„Éº„Éê„É´ÂÆå‰∫ÜÔºÅ');
                            resetInterval();
                            return;
                        }
                        currentIntervalSet++;
                        isWorkTime = true;
                        intervalTime = workMinutes * 60;
                        alert('‰ΩúÊ•≠ÊôÇÈñì„Åß„ÅôÔºÅ');
                    }
                    updateIntervalStatus(totalSets);
                }
            }, 1000);
            
            document.getElementById('timerDisplay').classList.add('active');
        }
        
        function pauseInterval() {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        function resetInterval() {
            clearInterval(timerInterval);
            timerInterval = null;
            intervalTime = 0;
            currentIntervalSet = 0;
            isWorkTime = true;
            updateIntervalDisplay();
            updateIntervalStatus(0);
            document.getElementById('timerDisplay').classList.remove('active');
        }
        
        function updateIntervalDisplay() {
            const minutes = Math.floor(intervalTime / 60);
            const seconds = intervalTime % 60;
            const display = `${pad(minutes)}:${pad(seconds)}`;
            document.getElementById('intervalDisplay').textContent = display;
            if (timerMode === 'interval') {
                document.getElementById('timerDisplay').textContent = display;
            }
        }
        
        function updateIntervalStatus(totalSets) {
            document.getElementById('intervalStatus').textContent = isWorkTime ? '‰ΩúÊ•≠‰∏≠' : '‰ºëÊÜ©‰∏≠';
            document.getElementById('intervalSetCount').textContent = `${currentIntervalSet}/${totalSets} „Çª„ÉÉ„Éà`;
        }
        
        function updateHeaderTimerDisplay() {
            if (timerMode === 'stopwatch') {
                updateStopwatchDisplay();
            } else if (timerMode === 'countdown') {
                updateCountdownDisplay();
            } else if (timerMode === 'interval') {
                updateIntervalDisplay();
            }
        }
        
        function pad(num) {
            return num.toString().padStart(2, '0');
        }
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºÊ©üËÉΩÔºàÊúàÊõú„Çπ„Çø„Éº„ÉàÔºâ
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthDisplay.textContent = `${year}Âπ¥${month + 1}Êúà`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            // ÊúàÊõú„Çπ„Çø„Éº„Éà„Å´Ë™øÊï¥Ôºà0=Êó•Êõú„Çí6„Å´„ÄÅ1-6„Çí„Åù„ÅÆ„Åæ„Åæ0-5„Å´Ôºâ
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            let html = '';
            
            // ÊõúÊó•„Éò„ÉÉ„ÉÄ„ÉºÔºàÊúàÊõú„Çπ„Çø„Éº„ÉàÔºâ
            const weekdays = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
            weekdays.forEach((day, index) => {
                const isWeekend = index >= 5; // ÂúüÊó•
                html += `<div class="calendar-weekday ${isWeekend ? 'weekend' : ''}">${day}</div>`;
            });
            
            // ÂâçÊúà„ÅÆÊó•‰ªò
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${prevLastDate - i}</div>`;
            }
            
            // ÂΩìÊúà„ÅÆÊó•‰ªò
            const today = new Date();
            for (let date = 1; date <= lastDate; date++) {
                const currentDay = new Date(year, month, date);
                const dayOfWeek = currentDay.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = currentDay.toDateString() === today.toDateString();
                const plans = getPlansForDate(currentDay);
                
                let classes = 'calendar-day';
                if (isWeekend) classes += ' weekend';
                if (isToday) classes += ' today';
                if (plans.length > 0) classes += ' has-plan';
                
                let planTexts = '';
                if (plans.length > 0) {
                    planTexts = '<div class="calendar-day-plans">';
                    plans.forEach(plan => {
                        const displayText = plan.displayType === 'bullet' ? '„Éª' : plan.title.substring(0, 8);
                        planTexts += `<div class="calendar-plan-text" style="color: ${plan.color};">${displayText}</div>`;
                    });
                    planTexts += '</div>';
                }
                
                html += `<div class="${classes}" onclick="selectDate(${year}, ${month}, ${date})">
                    <div class="calendar-day-number">${date}</div>
                    ${planTexts}
                </div>`;
            }
            
            // Ê¨°Êúà„ÅÆÊó•‰ªò
            const remainingDays = 42 - (firstDayOfWeek + lastDate);
            for (let date = 1; date <= remainingDays; date++) {
                html += `<div class="calendar-day other-month">${date}</div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }
        
        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }
        
        function selectDate(year, month, date) {
            selectedDate = new Date(year, month, date);
            openPlanModalForDate(selectedDate);
        }
        
        // Êó•‰ªò„ÇíÊåáÂÆö„Åó„Å¶Ë®àÁîª„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openPlanModalForDate(date) {
            document.getElementById('planModal').classList.add('active');
            document.getElementById('planModalTitle').textContent = 'üìÖ Â≠¶ÁøíË®àÁîª„ÇíËøΩÂä†';
            document.getElementById('planFormSection').style.display = 'block';
            document.getElementById('planListSection').style.display = 'none';
            
            // ÈÅ∏Êäû„Åó„ÅüÊó•‰ªò„ÇíÂàùÊúüÂÄ§„Å´Ë®≠ÂÆö
            const dateStr = date.toISOString().split('T')[0];
            document.getElementById('planStartDate').value = dateStr;
            document.getElementById('planEndDate').value = dateStr;
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('planTitle').value = '';
            document.getElementById('planContent').value = '';
            document.getElementById('editPlanId').value = '';
            document.querySelector('input[name="displayType"][value="bullet"]').checked = true;
        }
        
        // Â≠¶ÁøíË®àÁîª„É¢„Éº„ÉÄ„É´
        function openPlanModal() {
            document.getElementById('planModal').classList.add('active');
            document.getElementById('planModalTitle').textContent = 'üìÖ Â≠¶ÁøíË®àÁîª„ÇíËøΩÂä†';
            document.getElementById('planFormSection').style.display = 'block';
            document.getElementById('planListSection').style.display = 'none';
            
            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíÂàùÊúüÂÄ§„Å´Ë®≠ÂÆö
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planStartDate').value = today;
            document.getElementById('planEndDate').value = today;
            document.getElementById('editPlanId').value = '';
        }
        
        function closePlanModal() {
            document.getElementById('planModal').classList.remove('active');
        }
        
        function viewPlans() {
            document.getElementById('planModal').classList.add('active');
            document.getElementById('planModalTitle').textContent = 'üìã Ë®àÁîª‰∏ÄË¶ß';
            document.getElementById('planFormSection').style.display = 'none';
            document.getElementById('planListSection').style.display = 'block';
            renderPlanList();
        }
        
        function savePlan() {
            const title = document.getElementById('planTitle').value;
            const content = document.getElementById('planContent').value;
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;
            const displayType = document.querySelector('input[name="displayType"]:checked').value;
            const editId = document.getElementById('editPlanId').value;
            
            if (!title || !startDate || !endDate) {
                alert('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (editId) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ
                const index = studyPlans.findIndex(p => p.id === parseInt(editId));
                if (index !== -1) {
                    studyPlans[index] = {
                        ...studyPlans[index],
                        title,
                        content,
                        startDate,
                        endDate,
                        color: selectedPlanColor,
                        displayType
                    };
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†
                const plan = {
                    id: Date.now(),
                    title,
                    content,
                    startDate,
                    endDate,
                    color: selectedPlanColor,
                    displayType
                };
                studyPlans.push(plan);
            }
            
            saveStudyPlans();
            renderCalendar();
            
            // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
            document.getElementById('planTitle').value = '';
            document.getElementById('planContent').value = '';
            document.getElementById('editPlanId').value = '';
            
            alert('Â≠¶ÁøíË®àÁîª„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            closePlanModal();
        }
        
        function editPlan(planId) {
            const plan = studyPlans.find(p => p.id === planId);
            if (!plan) return;
            
            document.getElementById('planModal').classList.add('active');
            document.getElementById('planModalTitle').textContent = 'üìÖ Â≠¶ÁøíË®àÁîª„ÇíÁ∑®ÈõÜ';
            document.getElementById('planFormSection').style.display = 'block';
            document.getElementById('planListSection').style.display = 'none';
            
            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('planTitle').value = plan.title;
            document.getElementById('planContent').value = plan.content || '';
            document.getElementById('planStartDate').value = plan.startDate;
            document.getElementById('planEndDate').value = plan.endDate;
            document.getElementById('editPlanId').value = plan.id;
            
            // Ë°®Á§∫ÂΩ¢Âºè„ÇíË®≠ÂÆö
            document.querySelector(`input[name="displayType"][value="${plan.displayType || 'text'}"]`).checked = true;
            
            // Ëâ≤„ÇíË®≠ÂÆö
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            const colorOption = document.querySelector(`.color-option[data-color="${plan.color}"]`);
            if (colorOption) {
                colorOption.classList.add('selected');
                selectedPlanColor = plan.color;
            }
        }
        
        function deletePlan(planId) {
            if (confirm('„Åì„ÅÆË®àÁîª„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                studyPlans = studyPlans.filter(p => p.id !== planId);
                saveStudyPlans();
                renderCalendar();
                renderPlanList();
            }
        }
        
        function renderPlanList() {
            const container = document.getElementById('planListContent');
            
            if (studyPlans.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">Ë®àÁîª„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            let html = '';
            studyPlans.forEach(plan => {
                html += `
                    <div class="plan-item">
                        <div style="display: flex; align-items: center;">
                            <div class="plan-item-color" style="background: ${plan.color};"></div>
                            <div class="plan-item-content">
                                <div class="plan-item-title">${plan.title}</div>
                                <div class="plan-item-date">${plan.startDate} „Äú ${plan.endDate}</div>
                            </div>
                        </div>
                        <div class="plan-item-actions">
                            <button class="plan-item-edit" onclick="editPlan(${plan.id})">‚úèÔ∏è</button>
                            <button class="plan-item-delete" onclick="deletePlan(${plan.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getPlansForDate(date) {
            return studyPlans.filter(plan => {
                const start = new Date(plan.startDate);
                const end = new Date(plan.endDate);
                const checkDate = new Date(date);
                
                // ÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                checkDate.setHours(0, 0, 0, 0);
                
                return checkDate >= start && checkDate <= end;
            });
        }
        
        function loadStudyPlans() {
            const saved = localStorage.getItem('studyPlans');
            if (saved) {
                studyPlans = JSON.parse(saved);
            }
        }
        
        function saveStudyPlans() {
            localStorage.setItem('studyPlans', JSON.stringify(studyPlans));
        }
        
        // „Çµ„É≥„Éó„É´„Éá„Éº„Çø
        function initializeSampleData() {
            if (Object.keys(books).length === 0) {
                // „Çµ„É≥„Éó„É´1: ËÇ¢Âà•ÈÅéÂéªÂïèÈõÜÔºàÈöéÂ±§ÊßãÈÄ†Ôºâ
                const sampleBook1 = {
                    id: 'sample-2024',
                    name: 'ÂêàÊ†ºÈù©ÂëΩ ËÇ¢Âà•ÈÅéÂéªÂïèÈõÜ 2024Âπ¥Áâà',
                    examType: 'gyousei',
                    numberingType: 'reset',
                    structure: {
                        'Ê∞ëÊ≥ï': {
                            type: 'subject',
                            children: {
                                'Á∑èÂâá': {
                                    type: 'chapter',
                                    children: {
                                        'Ê®©Âà©ËÉΩÂäõ': {
                                            type: 'section',
                                            questions: [1, 2, 3, 4, 5]
                                        },
                                        'ÊÑèÊÄùËÉΩÂäõ': {
                                            type: 'section',
                                            questions: [1, 2, 3, 4, 5]
                                        }
                                    }
                                }
                            }
                        },
                        'Ë°åÊîøÊ≥ï': {
                            type: 'subject',
                            children: {
                                'Ë°åÊîø‰∏ª‰Ωì': {
                                    type: 'chapter',
                                    children: {
                                        'ÂõΩ„Å®Âú∞Êñπ': {
                                            type: 'section',
                                            questions: [1, 2, 3, 4, 5]
                                        }
                                    }
                                }
                            }
                        }
                    },
                    createdAt: new Date().toISOString()
                };
                
                // „Çµ„É≥„Éó„É´2: Âπ¥Â∫¶Âà•ÈÅéÂéªÂïèÔºàÁ´†„Å´Áõ¥Êé•ÂïèÈ°åÔºâ
                const sampleBook2 = {
                    id: 'sample-kakomond-2024',
                    name: 'Ë°åÊîøÊõ∏Â£´Ë©¶È®ì ÈÅéÂéªÂïèÈõÜ',
                    examType: 'gyousei',
                    numberingType: 'continuous',
                    structure: {
                        'Âπ¥Â∫¶Âà•ÈÅéÂéªÂïè': {
                            type: 'subject',
                            children: {
                                '‰ª§Âíå6Âπ¥Â∫¶': {
                                    type: 'chapter',
                                    questions: Array.from({length: 60}, (_, i) => i + 1),
                                    children: {}
                                },
                                '‰ª§Âíå5Âπ¥Â∫¶': {
                                    type: 'chapter',
                                    questions: Array.from({length: 60}, (_, i) => i + 61),
                                    children: {}
                                }
                            }
                        }
                    },
                    createdAt: new Date().toISOString()
                };
                
                books[sampleBook1.id] = sampleBook1;
                books[sampleBook2.id] = sampleBook2;
                bookOrder = [sampleBook1.id, sampleBook2.id];
                saveBooksToStorage();
                saveBookOrder();
                
                // „Çµ„É≥„Éó„É´‰∏ÄÂïè‰∏ÄÁ≠î„Éá„Éº„Çø
                const sampleQA = {
                    '„Çµ„É≥„Éó„É´ÂïèÈ°åÈõÜ': [
                        {
                            id: 1,
                            question: 'Êó•Êú¨ÂõΩÊÜ≤Ê≥ï„Åå‰øùÈöú„Åô„ÇãÂü∫Êú¨ÁöÑ‰∫∫Ê®©„ÅÆ‰∏≠„Åß„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å®„Åï„Çå„ÇãÊ®©Âà©„ÅØ‰Ωï„ÅãÔºü',
                            answer: 'ÂÄã‰∫∫„ÅÆÂ∞äÂé≥ÔºàÊÜ≤Ê≥ï13Êù°Ôºâ„ÄÇ„Åô„Åπ„Å¶„ÅÆÂü∫Êú¨ÁöÑ‰∫∫Ê®©„ÅÆÊ†πÂ∫ï„Å´„ÅÇ„ÇãÊ®©Âà©„Å®„Åï„Çå„Çã„ÄÇ'
                        }
                    ]
                };
                
                qaQuestions = sampleQA;
                saveQAQuestions();
            }
        }
        
        // LocalStorageÊìç‰Ωú
        function loadBooksFromStorage() {
            const stored = localStorage.getItem('studyTrackerBooks');
            if (stored) {
                books = JSON.parse(stored);
            }
        }
        
        function saveBooksToStorage() {
            localStorage.setItem('studyTrackerBooks', JSON.stringify(books));
        }
        
        function loadAllRecords() {
            const history = localStorage.getItem('studyHistory');
            if (history) {
                allRecords = JSON.parse(history);
            }
        }
        
        function loadSavedQuestionStates() {
            const saved = localStorage.getItem('savedQuestionStates');
            if (saved) {
                savedQuestionStates = JSON.parse(saved);
            }
        }
        
        function saveQuestionStatesForPath() {
            if (currentBook && currentPath.length > 0) {
                const key = `${currentBook.id}_${currentPath.join('/')}`;
                savedQuestionStates[key] = questionStates;
                localStorage.setItem('savedQuestionStates', JSON.stringify(savedQuestionStates));
            }
        }
        
        function loadQuestionStatesForPath() {
            if (currentBook && currentPath.length > 0) {
                const key = `${currentBook.id}_${currentPath.join('/')}`;
                if (savedQuestionStates[key]) {
                    questionStates = savedQuestionStates[key];
                    applyQuestionStates();
                }
            }
        }
        
        function applyQuestionStates() {
            Object.entries(questionStates).forEach(([num, state]) => {
                const cell = document.querySelector(`[data-number="${num}"]`);
                if (cell) {
                    cell.classList.remove('correct', 'wrong', 'bookmarked');
                    if (state.state === 'correct') {
                        cell.classList.add('correct');
                    } else if (state.state === 'wrong') {
                        cell.classList.add('wrong');
                    }
                    if (state.bookmarked) {
                        cell.classList.add('bookmarked');
                    }
                }
            });
            updateStats();
        }
        
        // ÂïèÈ°åÈõÜ„Ç´„Éº„ÉâË°®Á§∫ÔºàÈñãÈñâÂºèÔºâ
        function renderBookCards() {
            const container = document.getElementById('bookCardsContainer');
            if (!container) return;
            
            let html = '';
            
            // È†ÜÂ∫è„Å´Âæì„Å£„Å¶Ë°®Á§∫
            const orderedBooks = bookOrder.filter(id => books[id]).map(id => books[id]);
            // È†ÜÂ∫è„Å´Âê´„Åæ„Çå„Å™„ÅÑÊñ∞„Åó„ÅÑÊú¨„ÇíËøΩÂä†
            Object.values(books).forEach(book => {
                if (!bookOrder.includes(book.id)) {
                    orderedBooks.push(book);
                    bookOrder.push(book.id);
                }
            });
            
            orderedBooks.forEach(book => {
                const questionCount = countQuestionsInBook(book);
                const sortClass = sortMode ? 'sortable' : '';
                html += `
                    <div class="book-card ${sortClass}" id="book-card-${book.id}" onclick="${sortMode ? '' : `toggleBookCard('${book.id}')`}">
                        <span class="book-card-drag-handle">‚ò∞</span>
                        <div class="book-card-title">üìö ${book.name}</div>
                        <div class="book-card-meta">
                            ${Object.keys(book.structure).length}ÁßëÁõÆ | ${questionCount}Âïè
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ÂïèÈ°åÈõÜ„Ç´„Éº„Éâ„ÅÆÈñãÈñâ
        function toggleBookCard(bookId) {
            const card = document.getElementById(`book-card-${bookId}`);
            
            // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
            if (selectedBookCard === bookId) {
                card.classList.remove('selected');
                selectedBookCard = null;
                currentBook = null;
                currentPath = [];
                document.getElementById('breadcrumb').style.display = 'none';
                document.getElementById('recordHierarchyContainer').style.display = 'none';
                document.getElementById('questionSection').style.display = 'none';
            } else {
                // ‰ªñ„ÅÆ„Ç´„Éº„Éâ„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                document.querySelectorAll('.book-card').forEach(c => {
                    c.classList.remove('selected');
                });
                
                // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû
                card.classList.add('selected');
                selectedBookCard = bookId;
                selectBook(bookId);
            }
        }
        
        // ÂïèÈ°åÈõÜÈÅ∏Êäû
        function selectBook(bookId) {
            currentBook = books[bookId];
            currentPath = [];
            
            document.getElementById('breadcrumb').style.display = 'flex';
            document.getElementById('questionSection').style.display = 'none';
            updateBreadcrumb();
            renderRecordHierarchy();
        }
        
        // Ë®òÈå≤Áî®ÈöéÂ±§Ë°®Á§∫
        function renderRecordHierarchy() {
            const container = document.getElementById('recordHierarchyContainer');
            if (!container || !currentBook) return;
            
            container.style.display = 'block';
            
            let structure = currentBook.structure;
            // „Éë„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË©≤ÂΩìÁÆáÊâÄ„Åæ„ÅßÁßªÂãï
            if (currentPath.length > 0) {
                for (let i = 0; i < currentPath.length; i++) {
                    if (structure[currentPath[i]]) {
                        structure = structure[currentPath[i]].children || {};
                    }
                }
            }
            
            let html = '<div class="hierarchy-list">';
            html += renderRecordLevel(structure, currentPath);
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Ë®òÈå≤Áî®ÈöéÂ±§„É¨„Éô„É´Ë°®Á§∫
        function renderRecordLevel(structure, basePath) {
            let html = '';
            
            Object.entries(structure).forEach(([name, item]) => {
                const currentPath = [...basePath, name];
                const pathStr = currentPath.join('/');
                const hasChildren = item.children && Object.keys(item.children).length > 0;
                const isExpanded = expandedNodes.has(pathStr);
                
                html += `<div class="hierarchy-item">`;
                
                if (item.questions) {
                    // Á´†„ÄÅÁØÄ„ÄÅÈ†Ö„ÅÆ„ÅÑ„Åö„Çå„Åß„ÇÇÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ
                    html += `
                        <div class="hierarchy-row" onclick="showQuestions('${pathStr}')">
                            <span style="width: 28px;"></span>
                            <span class="hierarchy-icon">${getHierarchyIcon(item.type)}</span>
                            <span class="hierarchy-label">${name}</span>
                            <span class="hierarchy-meta">${item.questions.length}Âïè</span>
                        </div>
                    `;
                    
                    // Á´†„ÇÑÁØÄ„ÅßÂïèÈ°å„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å¶„ÇÇ„ÄÅÂ≠êË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞Â±ïÈñãÂèØËÉΩ
                    if (hasChildren) {
                        html += `
                            <div class="hierarchy-children ${isExpanded ? 'expanded' : ''}">
                                ${renderRecordLevel(item.children, currentPath)}
                            </div>
                        `;
                    }
                } else if (hasChildren) {
                    // Â≠êË¶ÅÁ¥†„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºà‚ñº„ÇíË°®Á§∫Ôºâ
                    html += `
                        <div class="hierarchy-row" onclick="toggleRecordNode('${pathStr}', event)">
                            <span class="hierarchy-toggle ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
                            <span class="hierarchy-icon">${getHierarchyIcon(item.type)}</span>
                            <span class="hierarchy-label">${name}</span>
                        </div>
                        <div class="hierarchy-children ${isExpanded ? 'expanded' : ''}">
                            ${renderRecordLevel(item.children, currentPath)}
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            return html;
        }
        
        // Ë®òÈå≤„Éé„Éº„ÉâÂ±ïÈñã/Êäò„Çä„Åü„Åü„Åø
        function toggleRecordNode(path, event) {
            event.stopPropagation();
            
            if (expandedNodes.has(path)) {
                expandedNodes.delete(path);
            } else {
                expandedNodes.add(path);
            }
            
            renderRecordHierarchy();
        }
        
        // „Éë„É≥„Åè„Åö„É™„Çπ„ÉàÊõ¥Êñ∞
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!currentBook) return;
            
            const items = [currentBook.name, ...currentPath];
            
            let html = '';
            items.forEach((item, index) => {
                if (index > 0) html += '<span class="breadcrumb-separator">‚Ä∫</span>';
                html += `<span class="breadcrumb-item ${index === items.length - 1 ? 'active' : ''}" 
                         onclick="navigateTo(${index - 1})">${item}</span>`;
            });
            
            breadcrumb.innerHTML = html;
        }
        
        // „Éë„É≥„Åè„Åö„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
        function navigateTo(index) {
            if (index === -1) {
                // ÂïèÈ°åÈõÜ„É¨„Éô„É´„Å´Êàª„Çã
                currentPath = [];
                document.getElementById('recordHierarchyContainer').style.display = 'block';
                document.getElementById('questionSection').style.display = 'none';
                renderRecordHierarchy();
            } else {
                // ÊåáÂÆö„Éë„Çπ„Å´ÁßªÂãï
                currentPath = currentPath.slice(0, index);
                document.getElementById('recordHierarchyContainer').style.display = 'block';
                document.getElementById('questionSection').style.display = 'none';
                renderRecordHierarchy();
            }
            updateBreadcrumb();
        }
        
        // ÂïèÈ°åË°®Á§∫
        function showQuestions(pathStr) {
            const pathArray = pathStr.split('/');
            currentPath = pathArray;
            updateBreadcrumb();
            
            let current = currentBook.structure;
            for (let i = 0; i < pathArray.length; i++) {
                if (current[pathArray[i]]) {
                    // ÊúÄÂæå„ÅÆË¶ÅÁ¥†„ÄÅ„Åæ„Åü„ÅØÈÄî‰∏≠„Åß„ÇÇÂïèÈ°å„ÇíÊåÅ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
                    if (current[pathArray[i]].questions) {
                        const item = current[pathArray[i]];
                        document.getElementById('recordHierarchyContainer').style.display = 'none';
                        document.getElementById('questionSection').style.display = 'block';
                        
                        const grid = document.getElementById('questionGrid');
                        grid.innerHTML = '';
                        questionStates = {};
                        
                        // Á´†„É¨„Éô„É´„ÅßÂïèÈ°å„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅÆÊ≥®Ë®ò„ÇíËøΩÂä†
                        if (item.type === 'chapter' && item.questions.length > 50) {
                            const note = document.createElement('div');
                            note.style.cssText = 'grid-column: 1 / -1; font-size: 11px; color: var(--gray); padding: 5px;';
                            note.textContent = `‚Äª ${item.questions.length}Âïè - Âπ¥Â∫¶Âà•ÈÅéÂéªÂïè`;
                            grid.appendChild(note);
                        }
                        
                        item.questions.forEach(num => {
                            const cell = document.createElement('div');
                            cell.className = 'question-cell';
                            cell.textContent = num;
                            cell.dataset.number = num;
                            cell.onclick = () => toggleQuestion(num);
                            
                            grid.appendChild(cell);
                            
                            questionStates[num] = {
                                state: null,
                                bookmarked: false
                            };
                        });
                        
                        // ‰øùÂ≠ò„Åï„Çå„ÅüÁä∂ÊÖã„ÇíË™≠„ÅøËæº„Åø
                        loadQuestionStatesForPath();
                        return;
                    }
                    current = current[pathArray[i]].children || {};
                }
            }
        }
        
        // „É°„Ç§„É≥„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchMainTab(tabName, event) {
            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'analysis') {
                updateChartBars();
                updateHeatmap();
                updateWeaknessAnalysis();
                updateHistoryContent();
            } else if (tabName === 'progress') {
                updateProgressContent();
                drawRadarChart();
            }
        }
        
        // „Éï„ÉÉ„Çø„Éº„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchFooterTab(tabName, event) {
            const modal = document.getElementById('footerModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const titles = {
                'register': 'üìù ÂïèÈ°åÈõÜÁôªÈå≤',
                'qa': '‚ùì ‰∏ÄÂïè‰∏ÄÁ≠î',
                'results': 'üèÜ Áç≤Âæó„Éê„ÉÉ„Ç∏',
                'settings': '‚öôÔ∏è Ë®≠ÂÆö'
            };
            
            modalTitle.textContent = titles[tabName];
            
            switch(tabName) {
                case 'register':
                    modalBody.innerHTML = getRegisterContent();
                    break;
                case 'qa':
                    modalBody.innerHTML = getQAContent();
                    break;
                case 'results':
                    modalBody.innerHTML = getResultsContent();
                    break;
                case 'settings':
                    modalBody.innerHTML = getSettingsContent();
                    break;
            }
            
            modal.classList.add('active');
        }
        
        function closeFooterModal() {
            document.getElementById('footerModal').classList.remove('active');
        }
        
        // ÂïèÈ°åÈõÜÁôªÈå≤„Ç≥„É≥„ÉÜ„É≥„ÉÑ
        function getRegisterContent() {
            let html = `
                <div class="save-button" style="margin: 10px;" onclick="showNewBookDialog()">Êñ∞Ë¶è‰ΩúÊàê</div>
                <div class="save-button" style="margin: 10px; background: var(--secondary);" onclick="showBookListDialog()">ÂïèÈ°åÈõÜ‰∏ÄË¶ß</div>
                <div style="margin-top: 20px;">
                    <h4 style="padding: 0 10px;">ÁôªÈå≤Ê∏à„ÅøÂïèÈ°åÈõÜ</h4>
                    <div id="registerHierarchy"></div>
                </div>
            `;
            
            setTimeout(() => {
                renderRegisterHierarchy();
            }, 100);
            
            return html;
        }
        
        // ÂïèÈ°åÈõÜ‰∏ÄË¶ß„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        function showBookListDialog() {
            let dialogBody = `
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            Object.values(books).forEach(book => {
                const questionCount = countQuestionsInBook(book);
                const numberingText = book.numberingType === 'continuous' ? 'ÈÄ£Áï™' : '„É™„Çª„ÉÉ„Éà';
                dialogBody += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--light);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${book.name}</div>
                                <div style="font-size: 12px; color: var(--gray);">
                                    ${Object.keys(book.structure).length}ÁßëÁõÆ | ${questionCount}Âïè | ${numberingText}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="hierarchy-action edit" onclick="editBookProperties('${book.id}')" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                <button class="hierarchy-action delete" onclick="deleteBook('${book.id}', event)" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            dialogBody += '</div>';
            
            showDialog('ÂïèÈ°åÈõÜ‰∏ÄË¶ß', dialogBody, () => {
                closeDialog();
            });
        }
        
        // ÂïèÈ°åÈõÜ„Éó„É≠„Éë„ÉÜ„Ç£Á∑®ÈõÜ
        function editBookProperties(bookId) {
            const book = books[bookId];
            if (!book) return;
            
            const dialogBody = `
                <div class="form-group">
                    <label class="form-label">ÂïèÈ°åÈõÜÂêç</label>
                    <input type="text" class="form-control" id="editBookName" value="${book.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂïèÈ°åÁï™Âè∑„Çø„Ç§„Éó</label>
                    <div class="numbering-type">
                        <label>
                            <input type="radio" name="editNumberingType" value="reset" ${book.numberingType === 'reset' ? 'checked' : ''}>
                            <span>È†ÖÁõÆ„Åî„Å®„É™„Çª„ÉÉ„Éà</span>
                        </label>
                        <label>
                            <input type="radio" name="editNumberingType" value="continuous" ${book.numberingType === 'continuous' ? 'checked' : ''}>
                            <span>ÈÄ£Áï™</span>
                        </label>
                    </div>
                </div>
            `;
            
            showDialog('ÂïèÈ°åÈõÜ„ÇíÁ∑®ÈõÜ', dialogBody, () => {
                const newName = document.getElementById('editBookName').value;
                const newNumberingType = document.querySelector('input[name="editNumberingType"]:checked').value;
                
                if (newName) {
                    book.name = newName;
                    book.numberingType = newNumberingType;
                    saveBooksToStorage();
                    renderBookCards();
                    updateHeatmapBookSelect();
                    updateRadarBookSelect();
                    closeDialog();
                    showBookListDialog();
                }
            });
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠î„Ç≥„É≥„ÉÜ„É≥„ÉÑ
        function getQAContent() {
            let html = `
                <div class="qa-card">
                    <div class="qa-selector">
                        <select id="qaSetSelect" onchange="selectQASet()">
                            <option value="">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû</option>
            `;
            
            Object.keys(qaQuestions).forEach(setName => {
                html += `<option value="${setName}">${setName}</option>`;
            });
            
            html += `
                        </select>
                        <button onclick="startQA()">ÈñãÂßã</button>
                    </div>
                    
                    <div class="qa-progress" id="qaProgress" style="display: none;">
                        <span class="qa-progress-text">ÂïèÈ°å <span id="qaCurrentNum">0</span> / <span id="qaTotalNum">0</span></span>
                        <div class="qa-stats">
                            <span class="qa-stat">Ê≠£Ëß£: <span class="qa-stat-value" id="qaCorrectCount">0</span></span>
                            <span class="qa-stat">‰∏çÊ≠£Ëß£: <span class="qa-stat-value" id="qaWrongCount">0</span></span>
                        </div>
                    </div>
                    
                    <div id="qaContent"></div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>ÂïèÈ°å„ÇíÊâãÂãïËøΩÂä†</h4>
                    <div class="form-group">
                        <label class="form-label">ÂïèÈ°åÈõÜÂêç</label>
                        <input type="text" class="form-control" id="qaNewSetName" placeholder="ÂïèÈ°åÈõÜÂêç">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂïèÈ°åÊñá</label>
                        <textarea class="form-control" id="qaNewQuestion" rows="3" placeholder="ÂïèÈ°åÊñá„ÇíÂÖ•Âäõ"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Á≠î„Åà</label>
                        <textarea class="form-control" id="qaNewAnswer" rows="3" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ"></textarea>
                    </div>
                    <button class="save-button" onclick="addQAQuestion()">ÂïèÈ°å„ÇíËøΩÂä†</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>ÁôªÈå≤Ê∏à„ÅøÂïèÈ°å</h4>
                    <div id="qaListContent"></div>
                </div>
            `;
            
            setTimeout(() => {
                renderQAList();
            }, 100);
            
            return html;
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠î„É™„Çπ„ÉàË°®Á§∫
        function renderQAList() {
            const container = document.getElementById('qaListContent');
            if (!container) return;
            
            let html = '';
            
            Object.entries(qaQuestions).forEach(([setName, questions]) => {
                html += `<h5>${setName} (${questions.length}Âïè)</h5>`;
                questions.forEach(q => {
                    html += `
                        <div class="delete-list-item">
                            <div>
                                <div style="font-weight: 600; font-size: 14px;">${q.question}</div>
                                <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">${q.answer}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteQAQuestion('${setName}', ${q.id})">ÂâäÈô§</button>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html || '<p style="color: var(--gray); text-align: center;">ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÂïèÈ°åËøΩÂä†
        function addQAQuestion() {
            const setName = document.getElementById('qaNewSetName').value || '„Åù„ÅÆ‰ªñ';
            const question = document.getElementById('qaNewQuestion').value;
            const answer = document.getElementById('qaNewAnswer').value;
            
            if (!question || !answer) {
                alert('ÂïèÈ°åÊñá„Å®Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!qaQuestions[setName]) {
                qaQuestions[setName] = [];
            }
            
            const newQuestion = {
                id: Date.now(),
                question,
                answer
            };
            
            qaQuestions[setName].push(newQuestion);
            saveQAQuestions();
            
            // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
            document.getElementById('qaNewQuestion').value = '';
            document.getElementById('qaNewAnswer').value = '';
            
            alert('ÂïèÈ°å„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
            renderQAList();
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÂïèÈ°åÂâäÈô§
        function deleteQAQuestion(setName, questionId) {
            if (confirm('„Åì„ÅÆÂïèÈ°å„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                qaQuestions[setName] = qaQuestions[setName].filter(q => q.id !== questionId);
                if (qaQuestions[setName].length === 0) {
                    delete qaQuestions[setName];
                }
                saveQAQuestions();
                renderQAList();
            }
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÈñãÂßã
        function startQA() {
            const select = document.getElementById('qaSetSelect');
            const setName = select.value;
            
            if (!setName || !qaQuestions[setName]) {
                alert('ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            currentQASet = [...qaQuestions[setName]];
            currentQAIndex = 0;
            qaStats = { total: currentQASet.length, correct: 0, wrong: 0 };
            qaAnswerShown = false;
            
            document.getElementById('qaProgress').style.display = 'flex';
            showQAQuestion();
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÂïèÈ°åË°®Á§∫
        function showQAQuestion() {
            if (currentQAIndex >= currentQASet.length) {
                showQAResult();
                return;
            }
            
            const question = currentQASet[currentQAIndex];
            const content = document.getElementById('qaContent');
            
            document.getElementById('qaCurrentNum').textContent = currentQAIndex + 1;
            document.getElementById('qaTotalNum').textContent = currentQASet.length;
            document.getElementById('qaCorrectCount').textContent = qaStats.correct;
            document.getElementById('qaWrongCount').textContent = qaStats.wrong;
            
            content.innerHTML = `
                <div class="qa-question">${question.question}</div>
                <div class="qa-answer ${qaAnswerShown ? 'show' : ''}" id="qaAnswer">${question.answer}</div>
                <div class="qa-controls">
                    ${!qaAnswerShown ? 
                        `<button class="qa-btn show-answer" onclick="showAnswer()">Á≠î„Åà„ÇíË¶ã„Çã</button>` :
                        `<button class="qa-btn correct" onclick="markQACorrect()">Ê≠£Ëß£</button>
                         <button class="qa-btn wrong" onclick="markQAWrong()">‰∏çÊ≠£Ëß£</button>`
                    }
                </div>
            `;
        }
        
        // Á≠î„ÅàË°®Á§∫
        function showAnswer() {
            qaAnswerShown = true;
            document.getElementById('qaAnswer').classList.add('show');
            showQAQuestion();
        }
        
        // Ê≠£Ëß£„Éû„Éº„ÇØ
        function markQACorrect() {
            qaStats.correct++;
            currentQAIndex++;
            qaAnswerShown = false;
            showQAQuestion();
        }
        
        // ‰∏çÊ≠£Ëß£„Éû„Éº„ÇØ
        function markQAWrong() {
            qaStats.wrong++;
            currentQAIndex++;
            qaAnswerShown = false;
            showQAQuestion();
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îÁµêÊûúË°®Á§∫
        function showQAResult() {
            const content = document.getElementById('qaContent');
            const rate = Math.round((qaStats.correct / qaStats.total) * 100);
            
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>ÁµêÊûú</h3>
                    <div class="stats-grid" style="margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-value">${qaStats.correct}</div>
                            <div class="stat-label">Ê≠£Ëß£</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${qaStats.wrong}</div>
                            <div class="stat-label">‰∏çÊ≠£Ëß£</div>
                        </div>
                    </div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);">Ê≠£Á≠îÁéá: ${rate}%</div>
                    <button class="save-button" style="margin-top: 20px;" onclick="startQA()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                </div>
            `;
        }
        
        // ÁôªÈå≤Áî®ÈöéÂ±§Ë°®Á§∫
        function renderRegisterHierarchy() {
            const container = document.getElementById('registerHierarchy');
            if (!container) return;
            
            let html = '<div class="hierarchy-list">';
            
            Object.values(books).forEach(book => {
                const nodeId = `book_${book.id}`;
                const isExpanded = expandedNodes.has(nodeId);
                
                html += `
                    <div class="hierarchy-item">
                        <div class="hierarchy-row" onclick="toggleRegisterNode('${nodeId}', event)">
                            <span class="hierarchy-toggle ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
                            <span class="hierarchy-icon">üìö</span>
                            <span class="hierarchy-label">${book.name}</span>
                            <div class="hierarchy-actions">
                                <button class="hierarchy-action" onclick="addHierarchy('${book.id}', null, 'subject', event)" title="ÁßëÁõÆËøΩÂä†">+</button>
                                <button class="hierarchy-action delete" onclick="deleteBook('${book.id}', event)" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="hierarchy-children ${isExpanded ? 'expanded' : ''}">
                            ${renderRegisterLevel(book.structure, book.id, [])}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ÁôªÈå≤ÈöéÂ±§„É¨„Éô„É´Ë°®Á§∫
        function renderRegisterLevel(structure, bookId, path) {
            let html = '';
            
            Object.entries(structure).forEach(([name, item]) => {
                const currentPath = [...path, name];
                const nodeId = `${bookId}_${currentPath.join('_')}`;
                const hasChildren = item.children && Object.keys(item.children).length > 0;
                const isExpanded = expandedNodes.has(nodeId);
                
                html += `
                    <div class="hierarchy-item">
                        <div class="hierarchy-row" ${hasChildren ? `onclick="toggleRegisterNode('${nodeId}', event)"` : ''}>
                            ${hasChildren ? `<span class="hierarchy-toggle ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>` : '<span style="width: 28px; display: inline-block;"></span>'}
                            <span class="hierarchy-icon">${getHierarchyIcon(item.type)}</span>
                            <span class="hierarchy-label">${name}</span>
                `;
                
                // ÂïèÈ°åÊï∞Ë°®Á§∫ÔºàÁ´†„ÄÅÁØÄ„ÄÅÈ†Ö„ÅÆ„ÅÑ„Åö„Çå„Åß„ÇÇÔºâ
                if (item.questions) {
                    html += `<span class="hierarchy-meta">${item.questions.length}Âïè</span>`;
                }
                
                // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
                html += '<div class="hierarchy-actions">';
                
                // Á∑®ÈõÜ„Éú„Çø„É≥
                html += `<button class="hierarchy-action edit" onclick="editHierarchy('${bookId}', '${currentPath.join('/')}', event)" title="Á∑®ÈõÜ">‚úèÔ∏è</button>`;
                
                if (item.type === 'subject') {
                    html += `<button class="hierarchy-action" onclick="addHierarchy('${bookId}', '${currentPath.join('/')}', 'chapter', event)" title="Á´†ËøΩÂä†">+</button>`;
                } else if (item.type === 'chapter') {
                    // Á´†„Åß„ÇÇÂïèÈ°å„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å¶„ÇÇÁØÄ„ÇíËøΩÂä†ÂèØËÉΩ
                    html += `<button class="hierarchy-action" onclick="addHierarchy('${bookId}', '${currentPath.join('/')}', 'section', event)" title="ÁØÄËøΩÂä†">+</button>`;
                } else if (item.type === 'section') {
                    // ÁØÄ„Åß„ÇÇÂïèÈ°å„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å¶„ÇÇÈ†Ö„ÇíËøΩÂä†ÂèØËÉΩÔºà„Åü„Å†„ÅóÊó¢„Å´È†Ö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                    html += `<button class="hierarchy-action" onclick="addHierarchy('${bookId}', '${currentPath.join('/')}', 'subsection', event)" title="È†ÖËøΩÂä†">+</button>`;
                }
                
                html += `<button class="hierarchy-action delete" onclick="deleteHierarchy('${bookId}', '${currentPath.join('/')}', event)" title="ÂâäÈô§">üóëÔ∏è</button>`;
                html += '</div></div>';
                
                if (hasChildren) {
                    html += `
                        <div class="hierarchy-children ${isExpanded ? 'expanded' : ''}">
                            ${renderRegisterLevel(item.children, bookId, currentPath)}
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            return html;
        }
        
        // ÁôªÈå≤„Éé„Éº„ÉâÂ±ïÈñã/Êäò„Çä„Åü„Åü„Åø
        function toggleRegisterNode(nodeId, event) {
            event.stopPropagation();
            
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            
            renderRegisterHierarchy();
        }
        
        // ÈöéÂ±§„Ç¢„Ç§„Ç≥„É≥ÂèñÂæóÔºàÈ†Ö„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÂâäÈô§Ôºâ
        function getHierarchyIcon(type) {
            const icons = {
                'subject': 'üìÇ',
                'chapter': 'üìÑ',
                'section': 'üìë',
                'subsection': ''  // È†Ö„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÅØÁ©∫„Å´
            };
            return icons[type] || 'üìÑ';
        }
        
        // „ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫
        function showDialog(title, body, onConfirm) {
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogBody').innerHTML = body;
            document.getElementById('dialogConfirmBtn').onclick = onConfirm;
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('inputDialog').style.display = 'block';
        }
        
        function closeDialog() {
            document.getElementById('dialogOverlay').style.display = 'none';
            document.getElementById('inputDialog').style.display = 'none';
        }
        
        // Êñ∞Ë¶èÂïèÈ°åÈõÜ‰ΩúÊàê„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        function showNewBookDialog() {
            const dialogBody = `
                <div class="form-group">
                    <label class="form-label">ÂïèÈ°åÈõÜÂêç</label>
                    <input type="text" class="form-control" id="newBookName" placeholder="ÂïèÈ°åÈõÜÂêç„ÇíÂÖ•Âäõ">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂïèÈ°åÁï™Âè∑„Çø„Ç§„Éó</label>
                    <div class="numbering-type">
                        <label>
                            <input type="radio" name="numberingType" value="reset" checked>
                            <span>È†ÖÁõÆ„Åî„Å®„É™„Çª„ÉÉ„Éà</span>
                        </label>
                        <label>
                            <input type="radio" name="numberingType" value="continuous">
                            <span>ÈÄ£Áï™</span>
                        </label>
                    </div>
                </div>
            `;
            
            showDialog('Êñ∞Ë¶èÂïèÈ°åÈõÜ‰ΩúÊàê', dialogBody, () => {
                const name = document.getElementById('newBookName').value;
                const numberingType = document.querySelector('input[name="numberingType"]:checked').value;
                
                if (!name) {
                    alert('ÂïèÈ°åÈõÜÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const bookId = 'book_' + Date.now();
                books[bookId] = {
                    id: bookId,
                    name: name,
                    examType: 'gyousei',
                    numberingType: numberingType,
                    structure: {},
                    createdAt: new Date().toISOString()
                };
                
                bookOrder.push(bookId);
                saveBooksToStorage();
                saveBookOrder();
                renderBookCards();
                renderRegisterHierarchy();
                updateHeatmapBookSelect();
                updateRadarBookSelect();
                closeDialog();
                alert('‰ΩúÊàê„Åó„Åæ„Åó„Åü');
            });
        }
        
        // ÈöéÂ±§ËøΩÂä†
        function addHierarchy(bookId, parentPath, type, event) {
            event.stopPropagation();
            
            const book = books[bookId];
            let dialogBody = `
                <div class="form-group">
                    <label class="form-label">${getTypeLabel(type)}„ÅÆÂêçÂâç</label>
                    <input type="text" class="form-control" id="hierarchyName" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
                </div>
            `;
            
            // Á´†„ÄÅÁØÄ„ÄÅÈ†Ö„ÅßÂïèÈ°åÊï∞„ÇíÂÖ•ÂäõÂèØËÉΩ„Å´
            if (type === 'chapter' || type === 'section' || type === 'subsection') {
                dialogBody += `
                    <div class="form-group">
                        <label class="form-label">ÂïèÈ°åÁï™Âè∑ÁØÑÂõ≤Ôºà‰ªªÊÑèÔºâ</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-control" id="questionStart" min="1" placeholder="ÈñãÂßãÁï™Âè∑" style="width: 100px;">
                            <span>„Äú</span>
                            <input type="number" class="form-control" id="questionEnd" min="1" placeholder="ÁµÇ‰∫ÜÁï™Âè∑" style="width: 100px;">
                        </div>
                    </div>
                `;
                
                // Áï™Âè∑„Çø„Ç§„Éó„ÅÆË™¨Êòé
                if (book.numberingType === 'continuous') {
                    dialogBody += `
                        <div style="font-size: 12px; color: var(--gray); margin-top: -10px; margin-bottom: 10px;">
                            ‚Äª ÈÄ£Áï™„É¢„Éº„ÉâÔºöÂÖ®‰Ωì„ÇíÈÄö„Åó„ÅüÁï™Âè∑„ÇíÂÖ•Âäõ
                        </div>
                    `;
                } else {
                    dialogBody += `
                        <div style="font-size: 12px; color: var(--gray); margin-top: -10px; margin-bottom: 10px;">
                            ‚Äª „É™„Çª„ÉÉ„Éà„É¢„Éº„ÉâÔºö„Åì„ÅÆÈ†ÖÁõÆÂÜÖ„Åß„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ
                        </div>
                    `;
                }
            }
            
            showDialog(`${getTypeLabel(type)}„ÇíËøΩÂä†`, dialogBody, () => {
                const name = document.getElementById('hierarchyName').value;
                if (!name) {
                    alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                let questions = null;
                if (type === 'chapter' || type === 'section' || type === 'subsection') {
                    const start = parseInt(document.getElementById('questionStart').value);
                    const end = parseInt(document.getElementById('questionEnd').value);
                    
                    if (start && end && start <= end) {
                        questions = [];
                        for (let i = start; i <= end; i++) {
                            questions.push(i);
                        }
                    }
                }
                
                let target = book.structure;
                
                if (parentPath) {
                    const pathArray = parentPath.split('/');
                    pathArray.forEach(p => {
                        if (target[p]) {
                            if (!target[p].children) {
                                target[p].children = {};
                            }
                            target = target[p].children;
                        }
                    });
                }
                
                if (questions) {
                    target[name] = {
                        type: type,
                        questions: questions
                    };
                    // Á´†„ÇÑÁØÄ„ÅßÂïèÈ°å„ÇíÊåÅ„Å§Â†¥Âêà„Åß„ÇÇ„ÄÅ„Åï„Çâ„Å´‰∏ã‰ΩçÈöéÂ±§„ÇíËøΩÂä†ÂèØËÉΩ„Å´„Åô„Çã
                    if (type === 'chapter' || type === 'section') {
                        target[name].children = {};
                    }
                } else {
                    target[name] = {
                        type: type,
                        children: {}
                    };
                }
                
                saveBooksToStorage();
                renderBookCards();
                renderRegisterHierarchy();
                closeDialog();
            });
        }
        
        // ÈöéÂ±§Á∑®ÈõÜÔºàÂêçÂâç„Å®ÂïèÈ°åÊï∞‰∏°ÊñπÂ§âÊõ¥ÂèØËÉΩÔºâ
        function editHierarchy(bookId, path, event) {
            event.stopPropagation();
            
            const book = books[bookId];
            const pathArray = path.split('/');
            let current = book.structure;
            let parent = null;
            let lastKey = pathArray[pathArray.length - 1];
            
            // ÂØæË±°„ÅÆÈ†ÖÁõÆ„ÇíÊé¢„Åô
            for (let i = 0; i < pathArray.length - 1; i++) {
                parent = current;
                current = current[pathArray[i]].children || {};
            }
            
            const item = current[lastKey] || (parent ? parent[lastKey] : null);
            if (!item) return;
            
            let dialogBody = `
                <div class="form-group">
                    <label class="form-label">ÂêçÁß∞</label>
                    <input type="text" class="form-control" id="editName" value="${lastKey}">
                </div>
            `;
            
            // Á´†„ÄÅÁØÄ„ÄÅÈ†Ö„ÅßÂïèÈ°å„ÇíÁ∑®ÈõÜÂèØËÉΩ„Å´
            if (item.type === 'chapter' || item.type === 'section' || item.type === 'subsection') {
                const start = item.questions ? Math.min(...item.questions) : '';
                const end = item.questions ? Math.max(...item.questions) : '';
                
                dialogBody += `
                    <div class="form-group">
                        <label class="form-label">ÂïèÈ°åÁï™Âè∑ÁØÑÂõ≤</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-control" id="editQuestionStart" value="${start}" min="1" placeholder="ÈñãÂßãÁï™Âè∑" style="width: 100px;">
                            <span>„Äú</span>
                            <input type="number" class="form-control" id="editQuestionEnd" value="${end}" min="1" placeholder="ÁµÇ‰∫ÜÁï™Âè∑" style="width: 100px;">
                        </div>
                    </div>
                `;
                
                if (book.numberingType === 'continuous') {
                    dialogBody += `
                        <div style="font-size: 12px; color: var(--gray); margin-top: -10px;">
                            ‚Äª ÈÄ£Áï™„É¢„Éº„ÉâÔºöÂÖ®‰Ωì„ÇíÈÄö„Åó„ÅüÁï™Âè∑
                        </div>
                    `;
                } else {
                    dialogBody += `
                        <div style="font-size: 12px; color: var(--gray); margin-top: -10px;">
                            ‚Äª „É™„Çª„ÉÉ„Éà„É¢„Éº„ÉâÔºö„Åì„ÅÆÈ†ÖÁõÆÂÜÖ„Åß„ÅÆÁï™Âè∑
                        </div>
                    `;
                }
            }
            
            showDialog('Á∑®ÈõÜ', dialogBody, () => {
                const newName = document.getElementById('editName').value;
                if (!newName) {
                    alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                // ÂêçÂâç„ÅÆÂ§âÊõ¥
                if (newName !== lastKey) {
                    current[newName] = current[lastKey];
                    delete current[lastKey];
                }
                
                // ÂïèÈ°åÁï™Âè∑„ÅÆÂ§âÊõ¥
                if (item.type === 'chapter' || item.type === 'section' || item.type === 'subsection') {
                    const start = parseInt(document.getElementById('editQuestionStart').value);
                    const end = parseInt(document.getElementById('editQuestionEnd').value);
                    
                    if (start && end && start <= end) {
                        const questions = [];
                        for (let i = start; i <= end; i++) {
                            questions.push(i);
                        }
                        current[newName].questions = questions;
                    } else {
                        // ÂïèÈ°å„ÇíÂâäÈô§
                        delete current[newName].questions;
                    }
                }
                
                saveBooksToStorage();
                renderBookCards();
                renderRegisterHierarchy();
                closeDialog();
            });
        }
        
        // ÈöéÂ±§ÂâäÈô§
        function deleteHierarchy(bookId, path, event) {
            event.stopPropagation();
            
            if (!confirm('„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            const book = books[bookId];
            const pathArray = path.split('/');
            
            if (pathArray.length === 1) {
                delete book.structure[pathArray[0]];
            } else {
                let target = book.structure;
                for (let i = 0; i < pathArray.length - 1; i++) {
                    if (target[pathArray[i]]) {
                        if (i === pathArray.length - 2) {
                            delete target[pathArray[i]].children[pathArray[pathArray.length - 1]];
                        } else {
                            target = target[pathArray[i]].children || {};
                        }
                    }
                }
            }
            
            saveBooksToStorage();
            renderBookCards();
            renderRegisterHierarchy();
        }
        
        // ÂïèÈ°åÈõÜÂâäÈô§
        function deleteBook(bookId, event) {
            event.stopPropagation();
            
            if (!confirm('„Åì„ÅÆÂïèÈ°åÈõÜ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            delete books[bookId];
            bookOrder = bookOrder.filter(id => id !== bookId);
            saveBooksToStorage();
            saveBookOrder();
            renderBookCards();
            renderRegisterHierarchy();
            updateHeatmapBookSelect();
            updateRadarBookSelect();
        }
        
        // Â≠¶ÁøíÂ±•Ê≠¥„Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞
        function updateHistoryContent() {
            const container = document.getElementById('historyContent');
            if (!container) return;
            
            let html = '';
            
            const recentRecords = allRecords.slice(-20).reverse();
            recentRecords.forEach(record => {
                const date = new Date(record.timestamp);
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--light);">
                        <div style="font-weight: 600;">${record.path.join(' ‚Ä∫ ')}</div>
                        <div style="font-size: 12px; color: var(--gray);">
                            ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            | Ê≠£Á≠îÁéá: ${record.stats.rate}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="color: var(--gray); text-align: center;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        }
        
        // ÂÆüÁ∏æ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
        function getResultsContent() {
            const stats = calculateOverallProgress();
            const streakDays = localStorage.getItem('streakDays') || '0';
            
            const badges = [
                { 
                    icon: 'üéØ', 
                    label: 'ÂàùÂ≠¶Áøí', 
                    unlocked: allRecords.length > 0,
                    value: allRecords.length > 0 ? 'ÈÅîÊàê' : 'Êú™ÈÅîÊàê'
                },
                { 
                    icon: 'üìö', 
                    label: '100Âïè', 
                    unlocked: stats.totalAnswered >= 100,
                    value: `${stats.totalAnswered}Âïè`
                },
                { 
                    icon: 'üî•', 
                    label: '7Êó•ÈÄ£Á∂ö', 
                    unlocked: parseInt(streakDays) >= 7,
                    value: `${streakDays}Êó•`
                },
                { 
                    icon: '‚≠ê', 
                    label: 'Ê≠£Á≠î90%', 
                    unlocked: stats.overallRate >= 90,
                    value: `${stats.overallRate}%`
                },
                { 
                    icon: 'üèÜ', 
                    label: '1000Âïè', 
                    unlocked: stats.totalAnswered >= 1000,
                    value: stats.totalAnswered >= 1000 ? 'ÈÅîÊàê' : `${stats.totalAnswered}Âïè`
                },
                { 
                    icon: 'üöÄ', 
                    label: 'ÂÖ®ÁßëÁõÆ', 
                    unlocked: Object.keys(calculateSubjectStats()).length >= 4,
                    value: `${Object.keys(calculateSubjectStats()).length}ÁßëÁõÆ`
                },
                { 
                    icon: 'üíé', 
                    label: '30Êó•Á∂ôÁ∂ö', 
                    unlocked: parseInt(streakDays) >= 30,
                    value: `${streakDays}Êó•`
                },
                { 
                    icon: 'üëë', 
                    label: '„Éû„Çπ„Çø„Éº', 
                    unlocked: stats.totalAnswered >= 5000 && stats.overallRate >= 85,
                    value: stats.totalAnswered >= 5000 ? 'ÈÅîÊàê' : 'Êú™ÈÅîÊàê'
                }
            ];
            
            let html = `
                <div class="card" style="margin: 10px;">
                    <h4 style="text-align: center; margin-bottom: 20px;">Áç≤Âæó„Éê„ÉÉ„Ç∏</h4>
                    <div class="achievement-grid">
            `;
            
            badges.forEach(badge => {
                html += `
                    <div class="achievement-card">
                        <div class="achievement-icon ${!badge.unlocked ? 'disabled' : ''}">${badge.icon}</div>
                        <div class="achievement-label">${badge.label}</div>
                        <div class="achievement-value">${badge.value}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Ë®≠ÂÆö„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàCSV„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜËøΩÂä†Ôºâ
        function getSettingsContent() {
            const currentExamDate = examDate ? examDate.toISOString().split('T')[0] : '';
            
            let html = `
                <div class="card" style="margin: 10px;">
                    <h4>üìÖ Ë©¶È®ìÊó•Ë®≠ÂÆö</h4>
                    <div class="form-group">
                        <label class="form-label">Ë©¶È®ìÊó•</label>
                        <input type="date" class="form-control" id="examDateInput" value="${currentExamDate}">
                        <button class="save-button" style="margin-top: 10px;" onclick="saveExamDate()">Ë©¶È®ìÊó•„ÇíË®≠ÂÆö</button>
                    </div>
                </div>
                
                <div class="card" style="margin: 10px;">
                    <h4>üì• ÂïèÈ°åÈõÜCSV„Ç§„É≥„Éù„Éº„Éà</h4>
                    <div class="import-section">
                        <label class="form-label">ÂïèÈ°åÈõÜÂêç</label>
                        <input type="text" class="form-control" id="importBookName" placeholder="ÂïèÈ°åÈõÜÂêç„ÇíÂÖ•Âäõ">
                        
                        <label class="form-label" style="margin-top: 15px;">Áï™Âè∑„Çø„Ç§„Éó</label>
                        <div class="numbering-type">
                            <label>
                                <input type="radio" name="importNumberingType" value="reset" checked>
                                <span>È†ÖÁõÆ„Åî„Å®„É™„Çª„ÉÉ„Éà</span>
                            </label>
                            <label>
                                <input type="radio" name="importNumberingType" value="continuous">
                                <span>ÈÄ£Áï™</span>
                            </label>
                        </div>
                        
                        <label class="form-label" style="margin-top: 15px;">CSVÂΩ¢Âºè„ÅÆÈöéÂ±§„Éá„Éº„Çø</label>
                        <textarea class="import-textarea" id="importCsvData" placeholder="CSVÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        
                        <div class="import-help">
                            <strong>CSVÂΩ¢Âºè„ÅÆ‰æãÔºö</strong><br>
                            ÁßëÁõÆ,Á´†,ÁØÄ,È†Ö,ÈñãÂßãÁï™Âè∑,ÁµÇ‰∫ÜÁï™Âè∑<br>
                            Ê∞ëÊ≥ï,Á∑èÂâá,Ê®©Âà©ËÉΩÂäõ,,1,5<br>
                            Ê∞ëÊ≥ï,Á∑èÂâá,ÊÑèÊÄùËÉΩÂäõ,,6,8<br>
                            Ê∞ëÊ≥ï,Áâ©Ê®©,Áâ©Ê®©Â§âÂãï,ÂØæÊäóË¶Å‰ª∂,1,10<br>
                            Ë°åÊîøÊ≥ï,Ë°åÊîø‰∏ª‰Ωì,,,1,20<br>
                            <br>
                            ‚Äª Á©∫Ê¨Ñ„ÅØÁúÅÁï•ÂèØËÉΩ„Åß„Åô<br>
                            ‚Äª ÈÄ£Áï™„É¢„Éº„Éâ„Åß„ÅØÂÖ®‰Ωì„ÅÆÈÄö„ÅóÁï™Âè∑„ÇíÂÖ•Âäõ<br>
                            ‚Äª „É™„Çª„ÉÉ„Éà„É¢„Éº„Éâ„Åß„ÅØÂêÑÈ†ÖÁõÆÂÜÖ„Åß„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ
                        </div>
                        
                        <button class="save-button" style="margin-top: 15px;" onclick="saveCSVTemplate()">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò</button>
                        <button class="save-button" style="margin-top: 10px; background: var(--success);" onclick="importCSV()">CSV„ÇíÂïèÈ°åÈõÜ„Å´ÈÅ©Áî®</button>
                        
                        <h5 style="margin-top: 20px;">‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà</h5>
                        <div class="csv-list" id="csvTemplateList"></div>
                    </div>
                </div>
                
                <div class="card" style="margin: 10px;">
                    <h4>üì• ‰∏ÄÂïè‰∏ÄÁ≠îCSV„Ç§„É≥„Éù„Éº„Éà</h4>
                    <div class="import-section">
                        <label class="form-label">ÂïèÈ°åÈõÜÂêç</label>
                        <input type="text" class="form-control" id="importQASetName" placeholder="ÂïèÈ°åÈõÜÂêç„ÇíÂÖ•Âäõ">
                        
                        <label class="form-label" style="margin-top: 15px;">CSVÂΩ¢Âºè„ÅÆÂïèÈ°å„Éá„Éº„Çø</label>
                        <textarea class="import-textarea" id="importQACsvData" placeholder="CSVÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        
                        <div class="import-help">
                            <strong>CSVÂΩ¢Âºè„ÅÆ‰æãÔºö</strong><br>
                            ÂïèÈ°å,Á≠î„Åà<br>
                            "Êó•Êú¨ÂõΩÊÜ≤Ê≥ï„Åå‰øùÈöú„Åô„ÇãÂü∫Êú¨ÁöÑ‰∫∫Ê®©„ÅÆ‰∏≠„Åß„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å®„Åï„Çå„ÇãÊ®©Âà©„ÅØ‰Ωï„ÅãÔºü","ÂÄã‰∫∫„ÅÆÂ∞äÂé≥ÔºàÊÜ≤Ê≥ï13Êù°Ôºâ"<br>
                            "Ë°åÊîøË°åÁÇ∫„ÅÆÂäπÂäõ„ÅÆ„ÅÜ„Å°„ÄÅÂÖ¨ÂÆöÂäõ„Å®„ÅØ‰Ωï„ÅãÔºü","Ë°åÊîøË°åÁÇ∫„ÅåÈÅïÊ≥ï„Åß„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÊ®©Èôê„ÅÇ„ÇãÊ©üÈñ¢„Å´„Çà„ÇäÂèñ„ÇäÊ∂à„Åï„Çå„Çã„Åæ„Åß„ÅØÊúâÂäπ„Å®„Åó„Å¶Êâ±„Çè„Çå„ÇãÂäπÂäõ"
                        </div>
                        
                        <button class="save-button" style="margin-top: 15px;" onclick="importQACSV()">‰∏ÄÂïè‰∏ÄÁ≠î„Çí„Ç§„É≥„Éù„Éº„Éà</button>
                    </div>
                </div>
                
                <div class="card" style="margin: 10px;">
                    <button class="save-button" style="background: var(--danger);" onclick="clearAllData()">„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§</button>
                </div>
            `;
            
            setTimeout(() => {
                renderCSVTemplateList();
            }, 100);
            
            return html;
        }
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò
        function saveCSVTemplate() {
            const csvData = document.getElementById('importCsvData').value;
            const bookName = document.getElementById('importBookName').value || 'Êú™ÂëΩÂêç„ÉÜ„É≥„Éó„É¨„Éº„Éà';
            
            if (!csvData) {
                alert('CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const templateId = 'template_' + Date.now();
            csvTemplates[templateId] = {
                id: templateId,
                name: bookName,
                data: csvData,
                createdAt: new Date().toISOString()
            };
            
            saveCSVTemplates();
            renderCSVTemplateList();
            alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„Éà„É™„Çπ„ÉàË°®Á§∫
        function renderCSVTemplateList() {
            const container = document.getElementById('csvTemplateList');
            if (!container) return;
            
            if (Object.keys(csvTemplates).length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            let html = '';
            Object.values(csvTemplates).forEach(template => {
                const date = new Date(template.createdAt);
                const lines = template.data.trim().split('\n').length - 1; // „Éò„ÉÉ„ÉÄ„ÉºÈô§„Åè
                
                html += `
                    <div class="csv-item">
                        <div class="csv-item-info">
                            <div class="csv-item-name">${template.name}</div>
                            <div class="csv-item-meta">
                                ${date.toLocaleDateString('ja-JP')} | ${lines}Ë°å
                            </div>
                        </div>
                        <div class="csv-item-actions">
                            <button class="csv-btn edit" onclick="editCSVTemplate('${template.id}')">Á∑®ÈõÜ</button>
                            <button class="csv-btn apply" onclick="applyCSVTemplate('${template.id}')">ÈÅ©Áî®</button>
                            <button class="csv-btn delete" onclick="deleteCSVTemplate('${template.id}')">ÂâäÈô§</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ
        function editCSVTemplate(templateId) {
            const template = csvTemplates[templateId];
            if (!template) return;
            
            document.getElementById('importBookName').value = template.name;
            document.getElementById('importCsvData').value = template.data;
        }
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®
        function applyCSVTemplate(templateId) {
            const template = csvTemplates[templateId];
            if (!template) return;
            
            const bookName = prompt('ÂïèÈ°åÈõÜÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', template.name);
            if (!bookName) return;
            
            const numberingType = confirm('ÈÄ£Áï™„É¢„Éº„Éâ„Å´„Åó„Åæ„Åô„ÅãÔºüÔºàOK„ÅßÈÄ£Áï™„ÄÅ„Ç≠„É£„É≥„Çª„É´„Åß„É™„Çª„ÉÉ„ÉàÔºâ') ? 'continuous' : 'reset';
            
            // ‰∏ÄÊôÇÁöÑ„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„Å¶„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å
            document.getElementById('importBookName').value = bookName;
            document.querySelector(`input[name="importNumberingType"][value="${numberingType}"]`).checked = true;
            document.getElementById('importCsvData').value = template.data;
            
            importCSV();
        }
        
        // CSV„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂâäÈô§
        function deleteCSVTemplate(templateId) {
            if (confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                delete csvTemplates[templateId];
                saveCSVTemplates();
                renderCSVTemplateList();
            }
        }
        
        // CSV„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩÔºàÊîπËâØÁâàÔºâ
        function importCSV() {
            const bookName = document.getElementById('importBookName').value;
            const csvData = document.getElementById('importCsvData').value;
            const numberingType = document.querySelector('input[name="importNumberingType"]:checked').value;
            
            if (!bookName || !csvData) {
                alert('ÂïèÈ°åÈõÜÂêç„Å®CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                const lines = csvData.trim().split('\n');
                
                // Êó¢Â≠ò„ÅÆÂïèÈ°åÈõÜ„ÇíÊé¢„Åô
                let bookId = null;
                let book = null;
                
                // ÂêåÂêç„ÅÆÂïèÈ°åÈõÜ„ÇíÊé¢„Åô
                for (let id in books) {
                    if (books[id].name === bookName) {
                        bookId = id;
                        book = books[id];
                        break;
                    }
                }
                
                // Êñ∞Ë¶è‰ΩúÊàê„Åæ„Åü„ÅØÊó¢Â≠ò„Å´ËøΩÂä†
                if (!book) {
                    bookId = 'book_' + Date.now();
                    book = {
                        id: bookId,
                        name: bookName,
                        examType: 'gyousei',
                        numberingType: numberingType,
                        structure: {},
                        createdAt: new Date().toISOString()
                    };
                    books[bookId] = book;
                    bookOrder.push(bookId);
                }
                
                // „Éò„ÉÉ„ÉÄ„ÉºË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                let startIndex = 0;
                if (lines[0].includes('ÁßëÁõÆ') || lines[0].includes('Á´†')) {
                    startIndex = 1;
                }
                
                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    const [subject, chapter, section, subsection, startNum, endNum] = parts;
                    
                    if (!subject) continue;
                    
                    // ÁßëÁõÆ„ÇíËøΩÂä†
                    if (!book.structure[subject]) {
                        book.structure[subject] = {
                            type: 'subject',
                            children: {}
                        };
                    }
                    
                    if (chapter) {
                        // Á´†„ÇíËøΩÂä†
                        if (!book.structure[subject].children[chapter]) {
                            book.structure[subject].children[chapter] = {
                                type: 'chapter',
                                children: {}
                            };
                        }
                        
                        if (section) {
                            // ÁØÄ„ÇíËøΩÂä†
                            if (!book.structure[subject].children[chapter].children[section]) {
                                book.structure[subject].children[chapter].children[section] = {
                                    type: 'section',
                                    children: {}
                                };
                            }
                            
                            if (subsection) {
                                // È†Ö„ÇíËøΩÂä†
                                if (!book.structure[subject].children[chapter].children[section].children[subsection]) {
                                    book.structure[subject].children[chapter].children[section].children[subsection] = {
                                        type: 'subsection'
                                    };
                                }
                                
                                // È†Ö„Å´ÂïèÈ°å„ÇíËøΩÂä†
                                if (startNum && endNum) {
                                    const questions = [];
                                    for (let j = parseInt(startNum); j <= parseInt(endNum); j++) {
                                        questions.push(j);
                                    }
                                    book.structure[subject].children[chapter].children[section].children[subsection].questions = questions;
                                }
                            } else {
                                // ÁØÄ„Å´ÂïèÈ°å„ÇíËøΩÂä†
                                if (startNum && endNum) {
                                    const questions = [];
                                    for (let j = parseInt(startNum); j <= parseInt(endNum); j++) {
                                        questions.push(j);
                                    }
                                    book.structure[subject].children[chapter].children[section].questions = questions;
                                }
                            }
                        } else {
                            // Á´†„Å´ÂïèÈ°å„ÇíËøΩÂä†
                            if (startNum && endNum) {
                                const questions = [];
                                for (let j = parseInt(startNum); j <= parseInt(endNum); j++) {
                                    questions.push(j);
                                }
                                book.structure[subject].children[chapter].questions = questions;
                            }
                        }
                    }
                }
                
                saveBooksToStorage();
                saveBookOrder();
                renderBookCards();
                updateHeatmapBookSelect();
                updateRadarBookSelect();
                
                alert('CSV„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
                closeFooterModal();
            } catch (error) {
                alert('CSV„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                console.error(error);
            }
        }
        
        // ‰∏ÄÂïè‰∏ÄÁ≠îCSV„Ç§„É≥„Éù„Éº„Éà
        function importQACSV() {
            const setName = document.getElementById('importQASetName').value;
            const csvData = document.getElementById('importQACsvData').value;
            
            if (!setName || !csvData) {
                alert('ÂïèÈ°åÈõÜÂêç„Å®CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                const lines = csvData.trim().split('\n');
                const questions = [];
                
                // „Éò„ÉÉ„ÉÄ„ÉºË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                let startIndex = 0;
                if (lines[0].includes('ÂïèÈ°å') || lines[0].includes('Á≠î„Åà')) {
                    startIndex = 1;
                }
                
                for (let i = startIndex; i < lines.length; i++) {
                    // „Ç´„É≥„Éû„ÇíÂê´„ÇÄÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÊ≠£Ë¶èË°®Áèæ„ÅßÂàÜÂâ≤
                    const match = lines[i].match(/^"([^"]+)","([^"]+)"$|^([^,]+),(.+)$/);
                    if (match) {
                        const question = match[1] || match[3];
                        const answer = match[2] || match[4];
                        
                        if (question && answer) {
                            questions.push({
                                id: Date.now() + i,
                                question: question.trim(),
                                answer: answer.trim()
                            });
                        }
                    }
                }
                
                if (questions.length > 0) {
                    if (!qaQuestions[setName]) {
                        qaQuestions[setName] = [];
                    }
                    qaQuestions[setName].push(...questions);
                    saveQAQuestions();
                    
                    alert(`${questions.length}Âïè„ÅÆÂïèÈ°å„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
                    closeFooterModal();
                } else {
                    alert('ÊúâÂäπ„Å™ÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                alert('CSV„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                console.error(error);
            }
        }
        
        // Ë©¶È®ìÊó•‰øùÂ≠ò
        function saveExamDate() {
            const input = document.getElementById('examDateInput');
            if (input && input.value) {
                examDate = new Date(input.value);
                localStorage.setItem('examDate', examDate.toISOString());
                updateExamCountdown();
                alert('Ë©¶È®ìÊó•„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü');
                closeFooterModal();
            }
        }
        
        // Ë®≠ÂÆö„Åã„ÇâÂïèÈ°åÈõÜÂâäÈô§
        function deleteBookFromSettings(bookId) {
            if (!confirm('„Åì„ÅÆÂïèÈ°åÈõÜ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            delete books[bookId];
            bookOrder = bookOrder.filter(id => id !== bookId);
            saveBooksToStorage();
            saveBookOrder();
            renderBookCards();
            updateHeatmapBookSelect();
            updateRadarBookSelect();
            closeFooterModal();
            alert('ÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        
        // „Éí„Éº„Éà„Éû„ÉÉ„ÉóÂïèÈ°åÈõÜÈÅ∏ÊäûÊõ¥Êñ∞
        function updateHeatmapBookSelect() {
            const select = document.getElementById('heatmapBookSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû</option>';
            
            Object.values(books).forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                select.appendChild(option);
            });
            
            // „Éî„É≥Âõ∫ÂÆö„Åï„Çå„ÅüÂïèÈ°åÈõÜ„Åå„ÅÇ„Çå„Å∞ÈÅ∏Êäû
            if (heatmapPinnedBook && books[heatmapPinnedBook]) {
                select.value = heatmapPinnedBook;
                updateHeatmap();
            }
        }
        
        // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„ÉàÂïèÈ°åÈõÜÈÅ∏ÊäûÊõ¥Êñ∞
        function updateRadarBookSelect() {
            const select = document.getElementById('radarBookSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû</option>';
            
            Object.values(books).forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                select.appendChild(option);
            });
            
            // „Éî„É≥Âõ∫ÂÆö„Åï„Çå„ÅüÂïèÈ°åÈõÜ„Åå„ÅÇ„Çå„Å∞ÈÅ∏Êäû
            if (radarPinnedBook && books[radarPinnedBook]) {
                select.value = radarPinnedBook;
                drawRadarChart();
            }
        }
        
        // „Åù„ÅÆ‰ªñ„ÅÆÈñ¢Êï∞„ÅØÂ§âÊõ¥„Å™„ÅóÔºàupdateHeatmap, drawRadarChart, etc...Ôºâ
        
        // „ÉÅ„É£„Éº„ÉàË°®Á§∫Èñ¢Êï∞„ÄÅÁµ±Ë®àË®àÁÆóÈñ¢Êï∞„Å™„Å©„Åô„Åπ„Å¶Âêå„Åò
        
        // ÂÖ®‰ΩìÈÄ≤ÊçóË®àÁÆó
        function calculateOverallProgress() {
            let totalQuestions = 0;
            let uniqueAnswered = new Set();
            let totalAnswered = 0;
            let totalCorrect = 0;
            
            // ÂÖ®ÂïèÈ°åÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            Object.values(books).forEach(book => {
                totalQuestions += countQuestionsInBook(book);
            });
            
            // Ëß£Á≠îÊ∏à„ÅøÂïèÈ°å„ÇíÈõÜË®à
            allRecords.forEach(record => {
                totalAnswered += record.stats.total || 0;
                totalCorrect += record.stats.correct || 0;
                
                // „É¶„Éã„Éº„ÇØ„Å™Ëß£Á≠îÊ∏à„ÅøÂïèÈ°å„ÇíË®òÈå≤
                Object.entries(record.questions).forEach(([num, state]) => {
                    if (state.state !== null) {
                        const key = `${record.bookId}_${record.path.join('/')}_${num}`;
                        uniqueAnswered.add(key);
                    }
                });
            });
            
            const uniqueAnsweredCount = uniqueAnswered.size;
            const overallRate = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
            const progressPercentage = totalQuestions > 0 ? Math.min(100, Math.round((uniqueAnsweredCount / totalQuestions) * 100)) : 0;
            
            return {
                totalQuestions,
                totalAnswered,
                totalCorrect,
                uniqueAnsweredCount,
                overallRate,
                progressPercentage
            };
        }
        
        // ÁßëÁõÆÂà•Áµ±Ë®àË®àÁÆó
        function calculateSubjectStats() {
            const subjectStats = {};
            
            allRecords.forEach(record => {
                const subject = record.path[0];
                if (!subject) return;
                
                if (!subjectStats[subject]) {
                    subjectStats[subject] = {
                        total: 0,
                        correct: 0,
                        wrong: 0
                    };
                }
                
                subjectStats[subject].total += record.stats.total || 0;
                subjectStats[subject].correct += record.stats.correct || 0;
                subjectStats[subject].wrong += record.stats.wrong || 0;
            });
            
            return subjectStats;
        }
        
        // ÂïèÈ°åÊï∞„Ç´„Ç¶„É≥„Éà
        function countQuestionsInBook(book) {
            let count = 0;
            
            function traverse(structure) {
                Object.values(structure).forEach(item => {
                    if (item.questions) {
                        count += item.questions.length;
                    }
                    if (item.children) {
                        traverse(item.children);
                    }
                });
            }
            
            traverse(book.structure);
            return count;
        }
        
        // „Çø„Ç§„Éó„É©„Éô„É´ÂèñÂæó
        function getTypeLabel(type) {
            const labels = {
                'subject': 'ÁßëÁõÆ',
                'chapter': 'Á´†',
                'section': 'ÁØÄ',
                'subsection': 'È†Ö'
            };
            return labels[type] || type;
        }
        
        // „Éá„Éº„Çø„ÇØ„É™„Ç¢
        function clearAllData() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // „Éí„Éº„Éà„Éû„ÉÉ„ÉóÊõ¥Êñ∞Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠£Ë™§Âàá„ÇäÊõø„ÅàÂèØËÉΩÔºâ
        function updateHeatmap() {
            const container = document.getElementById('heatmapGrid');
            const select = document.getElementById('heatmapBookSelect');
            if (!container || !select) return;
            
            const bookId = select.value;
            if (!bookId) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }
            
            const book = books[bookId];
            if (!book) return;
            
            let html = '';
            const allQuestions = getAllQuestionsFromBook(book);
            let currentLabel = '';
            
            allQuestions.forEach(q => {
                // „É©„Éô„É´Ë°®Á§∫
                const label = `${q.subject} ‚Ä∫ ${q.chapter}${q.section ? ' ‚Ä∫ ' + q.section : ''}${q.subsection ? ' ‚Ä∫ ' + q.subsection : ''}`;
                if (label !== currentLabel) {
                    currentLabel = label;
                    html += `<div class="heatmap-label">${label}</div>`;
                }
                
                const state = getQuestionStateFromRecords(book.id, q);
                let cellClass = '';
                
                if (state.wrong) cellClass = 'wrong';
                else if (state.correct) cellClass = 'correct';
                
                if (state.bookmarked) {
                    cellClass += ' bookmarked';
                }
                
                html += `<div class="heatmap-cell ${cellClass}" 
                         onclick="toggleHeatmapQuestion('${book.id}', '${q.path.join('/')}', '${q.number}')">${q.number}</div>`;
            });
            
            container.innerHTML = html || '<p style="color: var(--gray); text-align: center;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        }
        
        // „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆÂïèÈ°åÁä∂ÊÖãÂàá„ÇäÊõø„Åà
        function toggleHeatmapQuestion(bookId, pathStr, questionNum) {
            const pathArray = pathStr.split('/');
            
            // Êó¢Â≠ò„ÅÆË®òÈå≤„ÇíÊé¢„Åô
            let existingRecordIndex = -1;
            for (let i = allRecords.length - 1; i >= 0; i--) {
                if (allRecords[i].bookId === bookId && 
                    allRecords[i].path.join('/') === pathStr) {
                    existingRecordIndex = i;
                    break;
                }
            }
            
            let record;
            if (existingRecordIndex !== -1) {
                record = allRecords[existingRecordIndex];
            } else {
                // Êñ∞„Åó„ÅÑË®òÈå≤„Çí‰ΩúÊàê
                record = {
                    bookId: bookId,
                    bookName: books[bookId].name,
                    path: pathArray,
                    questions: {},
                    timestamp: new Date().toISOString(),
                    stats: { total: 0, correct: 0, wrong: 0, rate: '0%' }
                };
                allRecords.push(record);
            }
            
            // ÂïèÈ°å„ÅÆÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà
            if (!record.questions[questionNum]) {
                record.questions[questionNum] = { state: 'correct', bookmarked: false };
            } else if (record.questions[questionNum].state === 'correct') {
                record.questions[questionNum].state = 'wrong';
            } else if (record.questions[questionNum].state === 'wrong') {
                record.questions[questionNum].state = null;
                delete record.questions[questionNum];
            } else {
                record.questions[questionNum].state = 'correct';
            }
            
            // Áµ±Ë®à„ÇíÊõ¥Êñ∞
            let total = 0, correct = 0, wrong = 0;
            Object.values(record.questions).forEach(q => {
                if (q.state) {
                    total++;
                    if (q.state === 'correct') correct++;
                    else if (q.state === 'wrong') wrong++;
                }
            });
            
            record.stats = {
                total,
                correct,
                wrong,
                rate: total > 0 ? Math.round((correct / total) * 100) + '%' : '0%'
            };
            
            // ‰øùÂ≠ò
            localStorage.setItem('studyHistory', JSON.stringify(allRecords));
            
            // „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
            updateHeatmap();
        }
        
        // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function setRadarMode(mode, btn) {
            radarChartMode = mode;
            document.querySelectorAll('#radarModeSubject, #radarModeCompare').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const select = document.getElementById('radarBookSelect');
            const toggleBtn = document.getElementById('radarToggleBtn');
            
            if (mode === 'compare') {
                // ÊØîËºÉ„É¢„Éº„Éâ„Åß„ÅØÂÖ®ÂïèÈ°åÈõÜ„ÅÆÁßëÁõÆÂà•Âπ≥Âùá„ÇíË°®Á§∫
                select.style.display = 'none';
                toggleBtn.style.display = 'none';
                drawRadarChartCompare();
            } else {
                // ÁßëÁõÆÂà•„É¢„Éº„Éâ„Åß„ÅØÈÅ∏Êäû„Åó„ÅüÂïèÈ°åÈõÜ„ÅÆÁßëÁõÆ„ÇíË°®Á§∫
                select.style.display = 'block';
                toggleBtn.style.display = 'block';
                drawRadarChart();
            }
        }
        
        // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„ÉàÊèèÁîªÔºàÂÆüÈöõ„ÅÆÂ≠¶Áøí„Éá„Éº„Çø„Å®ÈÄ£ÂãïÔºâ
        function drawRadarChart() {
            if (radarChartMode === 'compare') {
                drawRadarChartCompare();
                return;
            }
            
            const canvas = document.getElementById('radarChart');
            const select = document.getElementById('radarBookSelect');
            if (!canvas || !select) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = 150;
            const centerY = 150;
            const radius = 100;
            
            const bookId = select.value;
            if (!bookId) {
                ctx.clearRect(0, 0, 300, 300);
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ÂïèÈ°åÈõÜ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', centerX, centerY);
                return;
            }
            
            const book = books[bookId];
            if (!book) return;
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÂïèÈ°åÈõÜ„ÅÆÁßëÁõÆÂà•Áµ±Ë®à„ÇíË®àÁÆó
            const subjectStats = calculateBookSubjectStats(bookId);
            const subjects = Object.keys(book.structure);
            
            // ÁßëÁõÆ„Åå6ÂÄã„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ6ÂÄã„ÅÆ„ÅøË°®Á§∫
            const displaySubjects = subjects.slice(0, 6);
            if (subjects.length > 6) {
                console.log(`Ê≥®ÊÑè: ${subjects.length}ÁßëÁõÆ‰∏≠„ÄÅÊúÄÂàù„ÅÆ6ÁßëÁõÆ„ÅÆ„ÅøË°®Á§∫`);
            }
            
            if (displaySubjects.length === 0) {
                ctx.clearRect(0, 0, 300, 300);
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', centerX, centerY);
                return;
            }
            
            const angleStep = (Math.PI * 2) / displaySubjects.length;
            
            // Clear canvas
            ctx.clearRect(0, 0, 300, 300);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 1; i <= 5; i++) {
                ctx.beginPath();
                for (let j = 0; j < displaySubjects.length; j++) {
                    const angle = j * angleStep - Math.PI / 2;
                    const x = centerX + Math.cos(angle) * (radius * i / 5);
                    const y = centerY + Math.sin(angle) * (radius * i / 5);
                    
                    if (j === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.closePath();
                ctx.stroke();
            }
            
            // Draw lines from center
            for (let i = 0; i < displaySubjects.length; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            // Draw data
            ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            displaySubjects.forEach((subject, i) => {
                const stats = subjectStats[subject] || { total: 0, correct: 0, wrong: 0 };
                const percentage = stats.total > 0 ? (stats.correct / stats.total) : 0;
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * (radius * percentage);
                const y = centerY + Math.sin(angle) * (radius * percentage);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#1f2937';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            displaySubjects.forEach((subject, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * (radius + 20);
                const y = centerY + Math.sin(angle) * (radius + 20);
                
                // Áü≠„ÅÑÁßëÁõÆÂêçË°®Á§∫
                const shortName = subject.length > 6 ? subject.substring(0, 6) + '...' : subject;
                ctx.fillText(shortName, x, y);
                
                // Ê≠£Á≠îÁéá„ÇíË°®Á§∫
                const stats = subjectStats[subject] || { total: 0, correct: 0, wrong: 0 };
                const rate = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`${rate}%`, x, y + 12);
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#1f2937';
            });
        }
        
        // ÂïèÈ°åÈõÜÊØîËºÉ„É¢„Éº„Éâ„ÅÆ„É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà
        function drawRadarChartCompare() {
            const canvas = document.getElementById('radarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = 150;
            const centerY = 150;
            const radius = 100;
            
            // ‰∏ªË¶ÅÁßëÁõÆ„ÇíÂÆöÁæ©ÔºàË°åÊîøÊõ∏Â£´Ë©¶È®ì„ÅÆÂ†¥ÂêàÔºâ
            const mainSubjects = ['Âü∫Á§éÊ≥ïÂ≠¶', 'ÊÜ≤Ê≥ï', 'Ë°åÊîøÊ≥ï', 'Ê∞ëÊ≥ï', 'ÂïÜÊ≥ï', '‰∏ÄËà¨Áü•Ë≠ò'];
            
            // ÂÖ®ÂïèÈ°åÈõÜ„Åã„ÇâÁßëÁõÆÂà•„Éá„Éº„Çø„ÇíÈõÜË®à
            const allSubjectStats = {};
            mainSubjects.forEach(subject => {
                allSubjectStats[subject] = { total: 0, correct: 0, wrong: 0 };
            });
            
            // ÂÖ®Ë®òÈå≤„Åã„Çâ‰∏ªË¶ÅÁßëÁõÆ„ÅÆ„Éá„Éº„Çø„ÇíÈõÜË®à
            allRecords.forEach(record => {
                if (record.path && record.path.length > 0) {
                    const subject = record.path[0];
                    if (mainSubjects.includes(subject)) {
                        if (record.questions) {
                            Object.values(record.questions).forEach(q => {
                                if (q.state === 'correct') {
                                    allSubjectStats[subject].correct++;
                                    allSubjectStats[subject].total++;
                                } else if (q.state === 'wrong') {
                                    allSubjectStats[subject].wrong++;
                                    allSubjectStats[subject].total++;
                                }
                            });
                        }
                    }
                }
            });
            
            const angleStep = (Math.PI * 2) / mainSubjects.length;
            
            // Clear canvas
            ctx.clearRect(0, 0, 300, 300);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 1; i <= 5; i++) {
                ctx.beginPath();
                for (let j = 0; j < mainSubjects.length; j++) {
                    const angle = j * angleStep - Math.PI / 2;
                    const x = centerX + Math.cos(angle) * (radius * i / 5);
                    const y = centerY + Math.sin(angle) * (radius * i / 5);
                    
                    if (j === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.closePath();
                ctx.stroke();
            }
            
            // Draw lines from center
            for (let i = 0; i < mainSubjects.length; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            // Draw data
            ctx.fillStyle = 'rgba(139, 92, 246, 0.3)';
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            mainSubjects.forEach((subject, i) => {
                const stats = allSubjectStats[subject];
                const percentage = stats.total > 0 ? (stats.correct / stats.total) : 0;
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * (radius * percentage);
                const y = centerY + Math.sin(angle) * (radius * percentage);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#1f2937';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            mainSubjects.forEach((subject, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * (radius + 20);
                const y = centerY + Math.sin(angle) * (radius + 20);
                
                ctx.fillText(subject, x, y);
                
                // Ê≠£Á≠îÁéá„ÇíË°®Á§∫
                const stats = allSubjectStats[subject];
                const rate = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`${rate}%`, x, y + 12);
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#1f2937';
            });
            
            // „Çø„Ç§„Éà„É´Ë°®Á§∫
            ctx.fillStyle = '#6b7280';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ÂÖ®ÂïèÈ°åÈõÜ„ÅÆÁµ±Âêà„Éá„Éº„Çø', centerX, 20);
        }
        
        // ÁâπÂÆö„ÅÆÂïèÈ°åÈõÜ„ÅÆÁßëÁõÆÂà•Áµ±Ë®à„ÇíË®àÁÆó
        function calculateBookSubjectStats(bookId) {
            const subjectStats = {};
            const book = books[bookId];
            
            // ÂïèÈ°åÈõÜ„ÅÆÁßëÁõÆ„ÇíÂàùÊúüÂåñ
            Object.keys(book.structure).forEach(subject => {
                subjectStats[subject] = {
                    total: 0,
                    correct: 0,
                    wrong: 0
                };
            });
            
            // Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„ÇíÈõÜË®à
            allRecords.forEach(record => {
                if (record.bookId === bookId && record.path && record.path.length > 0) {
                    const subject = record.path[0];
                    if (subject && subjectStats[subject]) {
                        // ÂêÑÂïèÈ°å„ÅÆÁä∂ÊÖã„ÇíÈõÜË®à
                        if (record.questions) {
                            Object.values(record.questions).forEach(q => {
                                if (q.state === 'correct') {
                                    subjectStats[subject].correct++;
                                    subjectStats[subject].total++;
                                } else if (q.state === 'wrong') {
                                    subjectStats[subject].wrong++;
                                    subjectStats[subject].total++;
                                }
                            });
                        }
                    }
                }
            });
            
            return subjectStats;
        }
        
        // „ÉÅ„É£„Éº„ÉàÂàá„ÇäÊõø„Åà
        function switchChartView(view, btn) {
            currentChartView = view;
            document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChartBars();
        }
        
        // „ÉÅ„É£„Éº„ÉàÊõ¥Êñ∞
        function updateChartBars() {
            const container = document.getElementById('chartBars');
            if (!container) return;
            
            let data = [];
            let labels = [];
            const today = new Date();
            
            if (currentChartView === 'day') {
                // ÈÅéÂéª7Êó•Èñì
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const count = getQuestionCountByDate(date);
                    data.push(count);
                    labels.push(date.getDate() + 'Êó•');
                }
            } else if (currentChartView === 'week') {
                // ÈÄ±ÈñìÔºàÊúà„ÄúÊó•Ôºâ
                const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
                const weekData = getWeekData();
                data = weekData;
                labels = days;
            } else if (currentChartView === 'month') {
                // ÊúàÈñìÔºà4ÈÄ±ÂàÜÔºâ
                for (let i = 3; i >= 0; i--) {
                    const weekStart = new Date();
                    weekStart.setDate(today.getDate() - (i * 7 + 6));
                    const weekEnd = new Date();
                    weekEnd.setDate(today.getDate() - (i * 7));
                    const count = getQuestionCountByDateRange(weekStart, weekEnd);
                    data.push(count);
                    labels.push(`Á¨¨${4-i}ÈÄ±`);
                }
            }
            
            const maxValue = Math.max(...data, 1);
            
            let html = '';
            data.forEach((value, index) => {
                const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
                const isToday = currentChartView === 'day' && index === data.length - 1;
                
                html += `
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar-value">${value}</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar ${isToday ? 'today' : ''}" style="height: ${height}%;"></div>
                        </div>
                        <div class="chart-bar-label">${labels[index]}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Êó•‰ªòÂà•ÂïèÈ°åÊï∞ÂèñÂæó
        function getQuestionCountByDate(date) {
            let count = 0;
            const dateStr = date.toDateString();
            
            allRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                if (recordDate.toDateString() === dateStr) {
                    count += record.stats.total || 0;
                }
            });
            
            return count;
        }
        
        // Êó•‰ªòÁØÑÂõ≤Âà•ÂïèÈ°åÊï∞ÂèñÂæó
        function getQuestionCountByDateRange(startDate, endDate) {
            let count = 0;
            
            allRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                if (recordDate >= startDate && recordDate <= endDate) {
                    count += record.stats.total || 0;
                }
            });
            
            return count;
        }
        
        // ÈÄ±Èñì„Éá„Éº„ÇøÂèñÂæó
        function getWeekData() {
            const weekData = [0, 0, 0, 0, 0, 0, 0];
            const today = new Date();
            const startOfWeek = new Date(today);
            const todayDay = today.getDay();
            const diff = todayDay === 0 ? 6 : todayDay - 1; // ÊúàÊõú„Çí0„Å®„Åô„Çã
            startOfWeek.setDate(today.getDate() - diff);
            
            allRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                if (recordDate >= startOfWeek) {
                    let dayIndex = recordDate.getDay();
                    dayIndex = dayIndex === 0 ? 6 : dayIndex - 1; // ÊúàÊõú„Çí0„Å®„Åô„Çã
                    if (dayIndex >= 0 && dayIndex < 7) {
                        weekData[dayIndex] += record.stats.total || 0;
                    }
                }
            });
            
            return weekData;
        }
        
        // ÂïèÈ°åÈõÜ„Åã„ÇâÂÖ®ÂïèÈ°å„ÇíÂèñÂæó
        function getAllQuestionsFromBook(book) {
            const questions = [];
            
            function traverse(structure, path = []) {
                Object.entries(structure).forEach(([name, item]) => {
                    const newPath = [...path, name];
                    
                    if (item.questions) {
                        item.questions.forEach(num => {
                            questions.push({
                                number: num,
                                subject: newPath[0],
                                chapter: newPath[1],
                                section: newPath[2],
                                subsection: newPath[3],
                                path: newPath
                            });
                        });
                    }
                    
                    if (item.children) {
                        traverse(item.children, newPath);
                    }
                });
            }
            
            traverse(book.structure);
            return questions;
        }
        
        // Ë®òÈå≤„Åã„ÇâÂïèÈ°å„ÅÆÁä∂ÊÖã„ÇíÂèñÂæó
        function getQuestionStateFromRecords(bookId, question) {
            let state = { correct: false, wrong: false, bookmarked: false };
            
            allRecords.forEach(record => {
                if (record.bookId === bookId) {
                    const pathMatch = record.path.join('/') === question.path.join('/');
                    if (pathMatch && record.questions[question.number]) {
                        const qState = record.questions[question.number];
                        if (qState.state === 'correct') state.correct = true;
                        if (qState.state === 'wrong') state.wrong = true;
                        if (qState.bookmarked) state.bookmarked = true;
                    }
                }
            });
            
            return state;
        }
        
        // Âº±ÁÇπÂàÜÊûêÊõ¥Êñ∞
        function updateWeaknessAnalysis() {
            const container = document.getElementById('weaknessAnalysis');
            if (!container) return;
            
            const subjectStats = calculateSubjectStats();
            const weaknesses = [];
            
            Object.entries(subjectStats).forEach(([subject, stats]) => {
                if (stats.total > 0) {
                    const percentage = Math.round((stats.correct / stats.total) * 100);
                    if (percentage < 70) {
                        weaknesses.push({
                            subject,
                            percentage,
                            wrong: stats.wrong
                        });
                    }
                }
            });
            
            weaknesses.sort((a, b) => a.percentage - b.percentage);
            
            if (weaknesses.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">Âº±ÁÇπÂàÜÈáé„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            } else {
                container.innerHTML = weaknesses.map(w => `
                    <div style="padding: 10px; background: #fef2f2; border-left: 3px solid var(--danger); border-radius: 5px; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: var(--danger);">${w.subject}</div>
                        <div style="font-size: 14px;">Ê≠£Á≠îÁéá: ${w.percentage}% | ÈñìÈÅï„ÅÑ: ${w.wrong}Âïè</div>
                    </div>
                `).join('');
            }
        }
        
        // ÈÄ≤Êçó„Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞
        function updateProgressContent() {
            const overallContainer = document.getElementById('overallProgress');
            
            const stats = calculateOverallProgress();
            
            overallContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalQuestions}</div>
                        <div class="stat-label">Á∑èÂïèÈ°åÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalAnswered}</div>
                        <div class="stat-label">Ëß£Á≠îÊ∏à„Åø</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalCorrect}</div>
                        <div class="stat-label">Ê≠£Ëß£Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.overallRate}%</div>
                        <div class="stat-label">Ê≠£Á≠îÁéá</div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${stats.progressPercentage}%;"></div>
                </div>
                <p style="text-align: center; margin-top: 10px;">ÈÄ≤ÊçóÁéá: ${stats.progressPercentage}%</p>
            `;
        }
        
        // „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleBookmarkMode() {
            bookmarkMode = !bookmarkMode;
            const btn = document.getElementById('bookmarkBtn');
            btn.classList.toggle('active');
        }
        
        // ÂïèÈ°åÈÅ∏Êäû
        function toggleQuestion(num) {
            if (bookmarkMode) {
                questionStates[num].bookmarked = !questionStates[num].bookmarked;
                const cell = document.querySelector(`[data-number="${num}"]`);
                cell.classList.toggle('bookmarked');
            } else {
                const cell = document.querySelector(`[data-number="${num}"]`);
                const state = questionStates[num];
                
                if (state.state === null) {
                    state.state = 'correct';
                    cell.classList.add('correct');
                } else if (state.state === 'correct') {
                    state.state = 'wrong';
                    cell.classList.remove('correct');
                    cell.classList.add('wrong');
                } else {
                    state.state = null;
                    cell.classList.remove('wrong');
                }
            }
            
            saveQuestionStatesForPath();
            updateStats();
        }
        
        // Ê≠£Ëß£„Éû„Éº„ÇØ
        function markCorrect() {
            Object.keys(questionStates).forEach(num => {
                if (questionStates[num].state === null) {
                    questionStates[num].state = 'correct';
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell) {
                        cell.classList.add('correct');
                    }
                }
            });
            saveQuestionStatesForPath();
            updateStats();
        }
        
        // ‰∏çÊ≠£Ëß£„Éû„Éº„ÇØ
        function markWrong() {
            Object.keys(questionStates).forEach(num => {
                if (questionStates[num].state === null) {
                    questionStates[num].state = 'wrong';
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell) {
                        cell.classList.add('wrong');
                    }
                }
            });
            saveQuestionStatesForPath();
            updateStats();
        }
        
        // Áµ±Ë®àÊõ¥Êñ∞
        function updateStats() {
            let total = 0;
            let correct = 0;
            let wrong = 0;
            
            Object.values(questionStates).forEach(state => {
                if (state.state !== null) {
                    total++;
                    if (state.state === 'correct') {
                        correct++;
                    } else {
                        wrong++;
                    }
                }
            });
            
            const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('correctRate').textContent = rate + '%';
        }
        
        // Ë®òÈå≤‰øùÂ≠ò
        function saveRecord() {
            const record = {
                bookId: currentBook.id,
                bookName: currentBook.name,
                path: currentPath,
                questions: questionStates,
                timestamp: new Date().toISOString(),
                stats: {
                    total: parseInt(document.getElementById('totalCount').textContent),
                    correct: parseInt(document.getElementById('correctCount').textContent),
                    wrong: parseInt(document.getElementById('wrongCount').textContent),
                    rate: document.getElementById('correctRate').textContent
                }
            };
            
            saveToHistory(record);
            updateDailyStreak();
            loadAllRecords();
            
            // ‰øùÂ≠òÂæå„ÇÇÂêå„Åò„Éö„Éº„Ç∏„Å´Áïô„Åæ„Çã
            alert('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        }
        
        // Â±•Ê≠¥‰øùÂ≠ò
        function saveToHistory(record) {
            let history = localStorage.getItem('studyHistory');
            history = history ? JSON.parse(history) : [];
            history.push(record);
            
            if (history.length > 1000) {
                history = history.slice(-1000);
            }
            
            localStorage.setItem('studyHistory', JSON.stringify(history));
        }
        
        // ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞Êõ¥Êñ∞
        function updateDailyStreak() {
            const today = new Date().toDateString();
            const lastStudyDate = localStorage.getItem('lastStudyDate');
            let streakDays = parseInt(localStorage.getItem('streakDays') || '0');
            
            if (lastStudyDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastStudyDate === yesterday.toDateString()) {
                    streakDays++;
                } else if (lastStudyDate !== today) {
                    streakDays = 1;
                }
                
                localStorage.setItem('lastStudyDate', today);
                localStorage.setItem('streakDays', streakDays.toString());
            }
        }
        
        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥
        function toggleAccordion(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }
    </script>
</body>
</html>
