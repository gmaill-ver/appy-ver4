<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学習トラッカー - 行政書士試験対策</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ヘッダー -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="タイマー">⏰</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">📚</span>
            <span class="app-title">学習トラッカー</span>
        </div>
        <div class="exam-countdown" id="examCountdown">試験日まで <span class="days">--</span> 日</div>
    </header>
    
    <!-- メインタブ -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">記録入力</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">分析</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">進捗</button>
    </div>
    
    <!-- コンテンツエリア -->
    <div class="content-area">
        <!-- 記録入力タブ -->
        <div id="record-tab" class="tab-content active">
            <!-- 問題集選択 -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">並替え</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- パンくずリスト -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- 階層リスト -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- 問題入力 -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">✍️</span>
                    <span class="card-title">問題別正誤入力</span>
                    <!-- ★追加: ページネーション -->
                    <div class="question-nav-buttons">
                        <button class="nav-btn" onclick="App.navigateQuestion(-1)" title="前へ">◀</button>
                        <button class="nav-btn" onclick="App.navigateQuestion(1)" title="次へ">▶</button>
                    </div>
                </div>
                
                <div class="action-buttons">
    <button class="action-btn correct" onclick="App.markCorrect()">
        <span style="font-size: 18px;">○</span>
    </button>
    <button class="action-btn wrong" onclick="App.markWrong()">
        <span style="font-size: 18px;">✕</span>
    </button>
    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
        <span style="font-size: 16px;">✓</span>
    </button>
    <!-- ★追加: リセットボタン -->
    <button class="action-btn reset" onclick="App.resetAllQuestions()">
        <span style="font-size: 16px;">↻</span>
    </button>
</div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">解答数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">不正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">正答率</div>
                    </div>
                </div>
                
            </div>
            
            <!-- カレンダー -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">◀</button>
                        <span class="calendar-month" id="calendarMonth">2025年1月</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">▶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">今日</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">📝 学習計画を追加</button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">📋 計画一覧</button>
                </div>
            </div>
        </div>
        
        <!-- 分析タブ -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">並替え</button>
            <div id="analysisCardsContainer">
                <!-- 学習グラフ -->
                <!-- 学習グラフ -->
                <div class="accordion" data-card-id="chart">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>📊 学習グラフ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">日別</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">週間</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">月間</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ヒートマップ -->
                <div class="accordion" data-card-id="heatmap">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>🗺️ 問題ヒートマップ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="heatmap-controls" style="display: flex; gap: 10px; align-items: center;">
    <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()" style="flex: 1; min-width: 0;">
        <option value="">問題集を選択</option>
    </select>
    <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">📌</button>
</div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- 弱点分析 -->
                <div class="accordion" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>🎯 弱点分析</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
                
                <!-- 学習履歴 -->
                <div class="accordion" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>📅 学習履歴</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 進捗タブ -->
<div id="progress-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <span class="card-icon">📊</span>
            <span class="card-title">全体進捗状況</span>
        </div>
        <div id="overallProgress"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <span class="card-icon">📈</span>
            <span class="card-title">科目別進捗</span>
        </div>
        <div class="radar-chart-container">
            <div class="radar-chart-controls">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()" style="flex: 1; min-width: 0;">
                        <option value="">問題集を選択</option>
                    </select>
                    <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">📌</button>
                </div>
            </div>
            <canvas id="radarChart" width="300" height="300"></canvas>
        </div>
    </div>
</div>
    </div>
    
    <!-- フッタータブ -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">📝</span>
            <span class="footer-tab-label">登録</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">❓</span>
            <span class="footer-tab-label">一問一答</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">📚</span>
            <span class="footer-tab-label">要点確認</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">🏆</span>
            <span class="footer-tab-label">実績</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">⚙️</span>
            <span class="footer-tab-label">設定</span>
        </button>
    </div>
    
    <!-- タイマーモーダル -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>⏰ タイマー</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">×</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ストップウォッチ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">タイマー</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">インターバル</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">リセット</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">タイマー設定</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="時" min="0" max="23">
                        <span>時間</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="分" min="0" max="59">
                        <span>分</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="秒" min="0" max="59">
                        <span>秒</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">リセット</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">作業時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">休憩時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">セット数</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>セット</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">待機中</span> | 
                    <span id="intervalSetCount">0/0 セット</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">リセット</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 学習計画モーダル -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">📅 学習計画</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">×</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">計画タイトル</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="例：民法総則の復習">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">計画内容</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="学習内容の詳細を入力"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">表示形式</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>・</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>通常表示</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">日付範囲</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>〜</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">色設定</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">計画を保存</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>登録済みの計画</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- フッターモーダル -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">タイトル</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">×</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">閉じる</button>
        </div>
    </div>
    
    <!-- 入力ダイアログ -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">タイトル</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">キャンセル</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">確定</button>
        </div>
    </div>

    <!-- 🔥 Firebase SDK v9 (Compat版) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- 🔧 Firebase設定＆初期化 -->
    <script>
    // Firebase設定
    const firebaseConfig = {
        apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
        authDomain: "gakushusintyoku.firebaseapp.com",
        projectId: "gakushusintyoku",
        storageBucket: "gakushusintyoku.firebasestorage.app",
        messagingSenderId: "386582438890",
        appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>

    <!-- 📱 JavaScript モジュール読み込み（順序重要） -->
    <script src="data-manager.js"></script>
    <script src="ui-components.js"></script>
    <script src="analytics.js"></script>
    <script src="qa-module.js"></script>
    <script src="timer-module.js"></script>
    <script src="keypoints-module.js"></script>
    <script src="app.js"></script>

    <!-- 🔥 完全固定ユーザーID版Firebase統合コード（キャッシュクリア完全対応） -->
<script>
console.log("🚀 Firebase統合開始（完全修正版）");

// 🔧 Firebase設定とオフライン永続化
try {
    firebase.firestore().enablePersistence({ 
        synchronizeTabs: true
    }).then(() => {
        console.log("✅ Firebase オフライン永続化有効");
    }).catch((err) => {
        if (err.code === 'failed-precondition') {
            console.log("⚠️ 複数タブ開いているため永続化無効");
        } else if (err.code === 'unimplemented') {
            console.log("⚠️ ブラウザが永続化非対応");
        }
    });
} catch (error) {
    console.error("Firebase設定エラー:", error);
}

// 🔑 超安定固定ユーザーID生成（完全固定版）
function generateUltraStableUserId() {
    const stableElements = [
        navigator.userAgent.split(' ')[0],
        navigator.platform,
        screen.width,
        screen.height,
        navigator.language,
        navigator.hardwareConcurrency || '4',
        new Date().getTimezoneOffset().toString()
    ];
    
    let hash = 'stable';
    const combined = stableElements.join('|');
    
    for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash + char) & 0xffffffff;
    }
    
    const isMobile = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
    const deviceType = isMobile ? 'mobile' : 'desktop';
    const baseId = Math.abs(hash).toString(36).padStart(8, '0');
    
    return `${deviceType}_${baseId}_permanent`;
}

// 🏪 複数ストレージからの確実なID取得
async function getOrCreateFixedUserId() {
    console.log("🔍 固定ID取得・生成開始");
    
    // 1. LocalStorageから取得
    let userId = localStorage.getItem('ultraStableUserId');
    if (userId) {
        console.log("✅ LocalStorageから固定ID取得:", userId);
        return userId;
    }
    
    // 2. IndexedDBから復旧試行
    try {
        const db = await openIndexedDB();
        const tx = db.transaction(['userData'], 'readonly');
        const store = tx.objectStore('userData');
        const request = store.get('fixedUserId');
        
        const result = await new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
        
        if (result && result.value) {
            userId = result.value;
            localStorage.setItem('ultraStableUserId', userId);
            console.log("✅ IndexedDBから固定ID復元:", userId);
            return userId;
        }
    } catch (error) {
        console.warn("IndexedDB読み込みスキップ:", error);
    }
    
    // 3. 新規生成
    userId = generateUltraStableUserId();
    localStorage.setItem('ultraStableUserId', userId);
    
    // IndexedDBにもバックアップ
    try {
        const db = await openIndexedDB();
        const tx = db.transaction(['userData'], 'readwrite');
        const store = tx.objectStore('userData');
        store.put({ id: 'fixedUserId', value: userId });
    } catch (error) {
        console.warn("IndexedDB保存スキップ:", error);
    }
    
    console.log("✅ 新規固定ID生成:", userId);
    return userId;
}

// IndexedDB操作
async function openIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('StudyTrackerDB', 1);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('userData')) {
                db.createObjectStore('userData', { keyPath: 'id' });
            }
        };
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// 🚀 固定IDの初期取得と設定
(async () => {
    try {
        const userId = await getOrCreateFixedUserId();
        window.ULTRA_STABLE_USER_ID = userId;
        
        // DataManagerに固定IDを設定
        if (window.DataManager) {
            DataManager.currentUser = { uid: userId };
            DataManager.firebaseEnabled = true;
        }
        
        console.log("✅ 固定ID確定:", window.ULTRA_STABLE_USER_ID);
        
        // 自動読み込みを実行
        setTimeout(() => {
            loadFromFirestore();
        }, 1000);
        
    } catch (error) {
        console.error("❌ 固定ID生成エラー:", error);
        window.ULTRA_STABLE_USER_ID = 'fallback_' + Date.now();
    }
})();

// 📥 Firebaseからのデータ読み込み（完全修正版）
async function loadFromFirestore() {
    if (!window.ULTRA_STABLE_USER_ID || !window.DataManager) {
        console.warn('⚠️ 固定IDまたはDataManagerが未設定');
        return;
    }
    
    try {
        const db = firebase.firestore();
        const userRef = db.collection('users').doc(window.ULTRA_STABLE_USER_ID);
        const userDoc = await userRef.get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            console.log('📥 Firebaseデータ発見:', {
                userId: userData.userId,
                books: Object.keys(userData.books || {}).length,
                records: (userData.allRecords || []).length,
                syncCount: userData.syncCount || 0
            });
            
            // DataManagerにデータを復元
            if (userData.books) DataManager.books = userData.books;
            if (userData.bookOrder) DataManager.bookOrder = userData.bookOrder;
            if (userData.allRecords) DataManager.allRecords = userData.allRecords;
            if (userData.savedQuestionStates) DataManager.savedQuestionStates = userData.savedQuestionStates;
            if (userData.studyPlans) DataManager.studyPlans = userData.studyPlans;
            if (userData.csvTemplates) DataManager.csvTemplates = userData.csvTemplates;
            if (userData.qaQuestions) DataManager.qaQuestions = userData.qaQuestions;
            if (userData.examDate) DataManager.examDate = new Date(userData.examDate);
            if (userData.deletedItems) DataManager.deletedItems = userData.deletedItems;
            if (userData.heatmapPinnedBook) DataManager.heatmapPinnedBook = userData.heatmapPinnedBook;
            if (userData.radarPinnedBook) DataManager.radarPinnedBook = userData.radarPinnedBook;
            if (userData.analysisCardOrder) DataManager.analysisCardOrder = userData.analysisCardOrder;
            
            // LocalStorageにも保存
            DataManager.saveAllData();
            
            // UI更新
            if (window.App && App.renderBookCards) {
                App.renderBookCards();
            }
            
            console.log('✅ Firebaseデータ復元完了');
        } else {
            console.log('⚠️ Firebaseにデータなし（新規ユーザー）');
        }
    } catch (error) {
        console.error('❌ Firebase読み込みエラー:', error);
    }
}

// 📤 DataManagerのFirebase保存機能を拡張
DataManager.saveToFirestore = async function(details = {}) {
    if (!window.ULTRA_STABLE_USER_ID) {
        console.warn('⚠️ 固定IDが未設定のため保存スキップ');
        return;
    }
    
    try {
        const db = firebase.firestore();
        const userRef = db.collection('users').doc(window.ULTRA_STABLE_USER_ID);
        
        const userData = {
            userId: window.ULTRA_STABLE_USER_ID,
            books: this.books || {},
            bookOrder: this.bookOrder || [],
            allRecords: this.allRecords || [],
            savedQuestionStates: this.savedQuestionStates || {},
            studyPlans: this.studyPlans || [],
            csvTemplates: this.csvTemplates || {},
            qaQuestions: this.qaQuestions || {},
            examDate: this.examDate ? this.examDate.toISOString() : null,
            deletedItems: this.deletedItems || [],
            heatmapPinnedBook: this.heatmapPinnedBook,
            radarPinnedBook: this.radarPinnedBook,
            analysisCardOrder: this.analysisCardOrder || [],
            lastSyncTime: firebase.firestore.FieldValue.serverTimestamp(),
            syncCount: firebase.firestore.FieldValue.increment(1),
            saveDetails: details,
            timestamp: new Date().toISOString()
        };
        
        await userRef.set(userData, { merge: true });
        console.log('✅ Firebase保存完了', details);
        
    } catch (error) {
        console.error('❌ Firebase保存エラー:', error);
    }
};

// 🔄 保存関数の拡張（全保存操作をFirebaseと同期）
window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        extendSaveFunctions();
    }, 2000);
});

function extendSaveFunctions() {
    // 各保存メソッドにFirebase保存を追加
    const originalMethods = {
        saveBooksToStorage: DataManager.saveBooksToStorage,
        saveBookOrder: DataManager.saveBookOrder,
        saveToHistory: DataManager.saveToHistory,
        saveQuestionStates: DataManager.saveQuestionStates,
        saveStudyPlans: DataManager.saveStudyPlans,
        saveQAQuestions: DataManager.saveQAQuestions,
        saveExamDate: DataManager.saveExamDate
    };
    
    // 各メソッドをオーバーライド
    DataManager.saveBooksToStorage = function() {
        const result = originalMethods.saveBooksToStorage.call(this);
        this.saveToFirestore({ type: 'books', action: 'save' });
        return result;
    };
    
    DataManager.saveBookOrder = function() {
        originalMethods.saveBookOrder.call(this);
        this.saveToFirestore({ type: 'bookOrder', action: 'save' });
    };
    
    DataManager.saveToHistory = function(record) {
        originalMethods.saveToHistory.call(this, record);
        this.saveToFirestore({ type: 'history', action: 'save' });
    };
    
    DataManager.saveQuestionStates = function(bookId, path, states) {
        originalMethods.saveQuestionStates.call(this, bookId, path, states);
        this.saveToFirestore({ type: 'questionStates', action: 'save' });
    };
    
    DataManager.saveStudyPlans = function() {
        originalMethods.saveStudyPlans.call(this);
        this.saveToFirestore({ type: 'plans', action: 'save' });
    };
    
    DataManager.saveQAQuestions = function() {
        originalMethods.saveQAQuestions.call(this);
        this.saveToFirestore({ type: 'qa', action: 'save' });
    };
    
    DataManager.saveExamDate = function(date) {
        const result = originalMethods.saveExamDate.call(this, date);
        this.saveToFirestore({ type: 'examDate', action: 'save' });
        return result;
    };
}

console.log("✅ Firebase統合コード読み込み完了（完全修正版）");
</script>
</body>
</html>
